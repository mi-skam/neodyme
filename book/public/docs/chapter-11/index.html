<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Chapter 11: &ldquo;I Need to Monitor and Debug Production Like a Professional&rdquo;#
Your neodyme application is running beautifully in production. Clean architecture, comprehensive error handling, secure authentication—everything you&rsquo;ve built is working exactly as designed. Then at 3 AM, you get the call: &ldquo;The application is down, users can&rsquo;t register, and we have no idea why.&rdquo;
You frantically check the server. The application is running. Database connections look fine. No obvious errors in the basic logs. But users are still reporting problems, and you&rsquo;re debugging blind with nothing but basic HTTP access logs and generic error messages.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://mi-skam.github.io/neodyme/docs/chapter-11/">
  <meta property="og:site_name" content="Neodyme Documentation">
  <meta property="og:title" content="Chapter 11">
  <meta property="og:description" content="Chapter 11: “I Need to Monitor and Debug Production Like a Professional”# Your neodyme application is running beautifully in production. Clean architecture, comprehensive error handling, secure authentication—everything you’ve built is working exactly as designed. Then at 3 AM, you get the call: “The application is down, users can’t register, and we have no idea why.”
You frantically check the server. The application is running. Database connections look fine. No obvious errors in the basic logs. But users are still reporting problems, and you’re debugging blind with nothing but basic HTTP access logs and generic error messages.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Chapter 11 | Neodyme Documentation</title>
<link rel="icon" href="/neodyme/favicon.png" >
<link rel="manifest" href="/neodyme/manifest.json">
<link rel="canonical" href="https://mi-skam.github.io/neodyme/docs/chapter-11/">
<link rel="stylesheet" href="/neodyme/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/neodyme/fuse.min.js"></script>
  <script defer src="/neodyme/en.search.min.c191579c4ae9a5777c9028306b9f9b99858fbbdd14be140a47e77b633882b215.js" integrity="sha256-wZFXnErppXd8kCgwa5&#43;bmYWPu90UvhQKR&#43;d7YziCshU=" crossorigin="anonymous"></script>

  
</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/neodyme/"><span>Neodyme Documentation</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>














  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-1/" class="">
      Chapter 1</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-2/" class="">
      Chapter 2</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-3/" class="">
      Chapter 3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-4/" class="">
      Chapter 4</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-5/" class="">
      Chapter 5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-6/" class="">
      Chapter 6</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-7/" class="">
      Chapter 7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-8/" class="">
      Chapter 8</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-9/" class="">
      Chapter 9</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-10/" class="">
      Chapter 10</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-11/" class="active">
      Chapter 11</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-12/" class="">
      Chapter 12</a>
  

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/neodyme/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Chapter 11</h3>

  <label for="toc-control">
    
    <img src="/neodyme/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-production-applications-as-black-boxes">The Problem: Production Applications as Black Boxes</a></li>
    <li><a href="#why-basic-monitoring-isnt-enough">Why Basic Monitoring Isn&rsquo;t Enough</a></li>
    <li><a href="#the-observability-solution-applications-that-explain-themselves">The Observability Solution: Applications That Explain Themselves</a>
      <ul>
        <li><a href="#structured-logging-making-logs-machine-readable">Structured Logging: Making Logs Machine-Readable</a></li>
        <li><a href="#request-tracking-middleware">Request Tracking Middleware</a></li>
        <li><a href="#service-level-instrumentation">Service-Level Instrumentation</a></li>
        <li><a href="#application-metrics-collection">Application Metrics Collection</a></li>
        <li><a href="#health-check-implementation">Health Check Implementation</a></li>
        <li><a href="#error-alerting-and-monitoring">Error Alerting and Monitoring</a></li>
      </ul>
    </li>
    <li><a href="#observability-integration-in-service-layer">Observability Integration in Service Layer</a></li>
    <li><a href="#testing-observability-implementation">Testing Observability Implementation</a></li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-for-next-chapters">Building Blocks for Next Chapters</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#observability-fundamentals">Observability Fundamentals</a></li>
        <li><a href="#structured-logging">Structured Logging</a></li>
        <li><a href="#metrics-and-monitoring">Metrics and Monitoring</a></li>
        <li><a href="#production-debugging">Production Debugging</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#next-scaling-beyond-one-machine">Next: Scaling Beyond One Machine</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="chapter-11-i-need-to-monitor-and-debug-production-like-a-professional">Chapter 11: &ldquo;I Need to Monitor and Debug Production Like a Professional&rdquo;<a class="anchor" href="#chapter-11-i-need-to-monitor-and-debug-production-like-a-professional">#</a></h1>
<p>Your neodyme application is running beautifully in production. Clean architecture, comprehensive error handling, secure authentication—everything you&rsquo;ve built is working exactly as designed. Then at 3 AM, you get the call: &ldquo;The application is down, users can&rsquo;t register, and we have no idea why.&rdquo;</p>
<p>You frantically check the server. The application is running. Database connections look fine. No obvious errors in the basic logs. But users are still reporting problems, and you&rsquo;re debugging blind with nothing but basic HTTP access logs and generic error messages.</p>
<p>This is the moment every production application faces: <strong>when things go wrong, how quickly can you understand what happened?</strong> The difference between systems that fail gracefully and those that create 3 AM panic calls isn&rsquo;t whether they have bugs—it&rsquo;s whether they provide the observability needed to debug issues quickly.</p>
<h2 id="the-problem-production-applications-as-black-boxes">The Problem: Production Applications as Black Boxes<a class="anchor" href="#the-problem-production-applications-as-black-boxes">#</a></h2>
<p>Let me ask you: Have you ever spent hours debugging an issue that could have been solved in minutes with better logging? If so, you&rsquo;ve experienced the pain of insufficient observability.</p>
<p>Here&rsquo;s what debugging looks like without proper monitoring:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># What you see in basic logs</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">42</span>] INFO: Starting user registration
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">43</span>] ERROR: Registration failed
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">44</span>] INFO: Starting user registration  
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">45</span>] ERROR: Registration failed
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">2024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">03</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span> <span style="color:#ae81ff">03</span>:<span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">46</span>] ERROR: Registration failed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># What you need to debug</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Which users are affected?</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - What specific step is failing?</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Is this a database issue, email service issue, or validation problem?</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - When did this pattern start?</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Are there any commonalities between failures?</span></span></span></code></pre></div><p><strong>Why basic logging creates debugging nightmares:</strong></p>
<ul>
<li><strong>No context correlation</strong> - You can&rsquo;t connect log entries to specific user requests or business operations</li>
<li><strong>Missing performance data</strong> - No insight into response times, database query performance, or external service latency</li>
<li><strong>Insufficient error details</strong> - Generic error messages don&rsquo;t provide enough information to understand root causes</li>
<li><strong>No operational metrics</strong> - You can&rsquo;t distinguish between isolated incidents and systematic problems</li>
<li><strong>Reactive debugging only</strong> - You discover problems only after users report them, not before they impact the business</li>
<li><strong>Time-consuming investigation</strong> - Every issue requires manual log analysis and hypothesis testing</li>
</ul>
<p>The fundamental problem is that <strong>applications need to tell you what they&rsquo;re doing</strong>, not just when they fail.</p>
<h2 id="why-basic-monitoring-isnt-enough">Why Basic Monitoring Isn&rsquo;t Enough<a class="anchor" href="#why-basic-monitoring-isnt-enough">#</a></h2>
<p>Traditional application monitoring looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Basic server monitoring</span>
</span></span><span style="display:flex;"><span>CPU: 45%
</span></span><span style="display:flex;"><span>Memory: 60% 
</span></span><span style="display:flex;"><span>Disk: 30%
</span></span><span style="display:flex;"><span>Network: Normal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Basic HTTP logs</span>
</span></span><span style="display:flex;"><span>192.168.1.100 - - <span style="color:#f92672">[</span>15/Mar/2024:03:15:42<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;POST /users/ HTTP/1.1&#34;</span> <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span>192.168.1.101 - - <span style="color:#f92672">[</span>15/Mar/2024:03:15:43<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;POST /users/ HTTP/1.1&#34;</span> <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span>192.168.1.102 - - <span style="color:#f92672">[</span>15/Mar/2024:03:15:44<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;POST /users/ HTTP/1.1&#34;</span> <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">45</span></span></span></code></pre></div><p><strong>This approach fails because:</strong></p>
<ul>
<li><strong>System metrics don&rsquo;t reveal application problems</strong> - CPU and memory usage look normal even when business logic is completely broken</li>
<li><strong>HTTP status codes hide business context</strong> - A 500 error could be a database timeout, email service failure, or validation issue</li>
<li><strong>No user journey tracking</strong> - You can&rsquo;t understand how individual user sessions progress through your application</li>
<li><strong>Missing dependencies visibility</strong> - External service failures are invisible until they cause user-facing errors</li>
<li><strong>No performance baselines</strong> - You can&rsquo;t distinguish between normal slowness and performance degradation</li>
</ul>
<h2 id="the-observability-solution-applications-that-explain-themselves">The Observability Solution: Applications That Explain Themselves<a class="anchor" href="#the-observability-solution-applications-that-explain-themselves">#</a></h2>
<p>Professional observability makes applications self-documenting through three pillars: <strong>logs</strong>, <strong>metrics</strong>, and <strong>traces</strong>. Here&rsquo;s how neodyme implements comprehensive observability:</p>
<h3 id="structured-logging-making-logs-machine-readable">Structured Logging: Making Logs Machine-Readable<a class="anchor" href="#structured-logging-making-logs-machine-readable">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/logging.py - Structured logging configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any, Dict, Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> contextvars <span style="color:#f92672">import</span> ContextVar
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> uuid <span style="color:#f92672">import</span> uuid4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Context variables for request correlation</span>
</span></span><span style="display:flex;"><span>request_id_var: ContextVar[str] <span style="color:#f92672">=</span> ContextVar(<span style="color:#e6db74">&#39;request_id&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>user_id_var: ContextVar[Optional[int]] <span style="color:#f92672">=</span> ContextVar(<span style="color:#e6db74">&#39;user_id&#39;</span>, default<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StructuredFormatter</span>(logging<span style="color:#f92672">.</span>Formatter):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;JSON formatter for structured logging.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">format</span>(self, record: logging<span style="color:#f92672">.</span>LogRecord) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Format log record as structured JSON.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Base log data</span>
</span></span><span style="display:flex;"><span>        log_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timestamp&#34;</span>: datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;level&#34;</span>: record<span style="color:#f92672">.</span>levelname,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;logger&#34;</span>: record<span style="color:#f92672">.</span>name,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;message&#34;</span>: record<span style="color:#f92672">.</span>getMessage(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;module&#34;</span>: record<span style="color:#f92672">.</span>module,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;function&#34;</span>: record<span style="color:#f92672">.</span>funcName,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;line&#34;</span>: record<span style="color:#f92672">.</span>lineno,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add request context if available</span>
</span></span><span style="display:flex;"><span>        request_id <span style="color:#f92672">=</span> request_id_var<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> request_id:
</span></span><span style="display:flex;"><span>            log_data[<span style="color:#e6db74">&#34;request_id&#34;</span>] <span style="color:#f92672">=</span> request_id
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        user_id <span style="color:#f92672">=</span> user_id_var<span style="color:#f92672">.</span>get(<span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> user_id:
</span></span><span style="display:flex;"><span>            log_data[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#f92672">=</span> user_id
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add exception information</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> record<span style="color:#f92672">.</span>exc_info:
</span></span><span style="display:flex;"><span>            log_data[<span style="color:#e6db74">&#34;exception&#34;</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;type&#34;</span>: record<span style="color:#f92672">.</span>exc_info[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__name__,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;message&#34;</span>: str(record<span style="color:#f92672">.</span>exc_info[<span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;traceback&#34;</span>: self<span style="color:#f92672">.</span>formatException(record<span style="color:#f92672">.</span>exc_info)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add extra context from log calls</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> hasattr(record, <span style="color:#e6db74">&#39;context&#39;</span>):
</span></span><span style="display:flex;"><span>            log_data[<span style="color:#e6db74">&#34;context&#34;</span>] <span style="color:#f92672">=</span> record<span style="color:#f92672">.</span>context
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>dumps(log_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup_logging</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Configure structured logging for the application.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Root logger configuration</span>
</span></span><span style="display:flex;"><span>    root_logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
</span></span><span style="display:flex;"><span>    root_logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>INFO)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Console handler with structured formatting</span>
</span></span><span style="display:flex;"><span>    console_handler <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>StreamHandler(sys<span style="color:#f92672">.</span>stdout)
</span></span><span style="display:flex;"><span>    console_handler<span style="color:#f92672">.</span>setFormatter(StructuredFormatter())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Remove default handlers</span>
</span></span><span style="display:flex;"><span>    root_logger<span style="color:#f92672">.</span>handlers<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    root_logger<span style="color:#f92672">.</span>addHandler(console_handler)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Configure third-party loggers</span>
</span></span><span style="display:flex;"><span>    logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;uvicorn.access&#34;</span>)<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>WARNING)
</span></span><span style="display:flex;"><span>    logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;sqlalchemy.engine&#34;</span>)<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>WARNING)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Structured logging helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_with_context</span>(logger: logging<span style="color:#f92672">.</span>Logger, level: int, message: str, <span style="color:#f92672">**</span>context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Log with additional context data.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    extra <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;context&#34;</span>: context}
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>log(level, message, extra<span style="color:#f92672">=</span>extra)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_user_action</span>(action: str, user_id: int, <span style="color:#f92672">**</span>context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Log user actions with consistent format.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.user_actions&#34;</span>)
</span></span><span style="display:flex;"><span>    log_with_context(
</span></span><span style="display:flex;"><span>        logger, 
</span></span><span style="display:flex;"><span>        logging<span style="color:#f92672">.</span>INFO, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;User action: </span><span style="color:#e6db74">{</span>action<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        user_id<span style="color:#f92672">=</span>user_id,
</span></span><span style="display:flex;"><span>        action<span style="color:#f92672">=</span>action,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">**</span>context
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">log_external_service_call</span>(service: str, operation: str, duration: float, success: bool, <span style="color:#f92672">**</span>context):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Log external service calls with performance data.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.external_services&#34;</span>)
</span></span><span style="display:flex;"><span>    log_with_context(
</span></span><span style="display:flex;"><span>        logger,
</span></span><span style="display:flex;"><span>        logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;External service call: </span><span style="color:#e6db74">{</span>service<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">{</span>operation<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        service<span style="color:#f92672">=</span>service,
</span></span><span style="display:flex;"><span>        operation<span style="color:#f92672">=</span>operation,
</span></span><span style="display:flex;"><span>        duration_ms<span style="color:#f92672">=</span>round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>        success<span style="color:#f92672">=</span>success,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">**</span>context
</span></span><span style="display:flex;"><span>    )</span></span></code></pre></div><p><strong>Why structured logging is essential for production debugging:</strong></p>
<ul>
<li><strong>Machine-readable format</strong> - JSON logs can be automatically parsed, searched, and analyzed by log aggregation tools</li>
<li><strong>Request correlation</strong> - Request IDs connect all log entries for a single user action, making debugging exponentially faster</li>
<li><strong>Rich context</strong> - Every log entry includes relevant business and technical context for understanding what happened</li>
<li><strong>Consistent format</strong> - Standardized log structure makes it easy to build dashboards and alerts</li>
<li><strong>Performance tracking</strong> - Duration and success metrics for external calls reveal performance bottlenecks immediately</li>
</ul>
<h3 id="request-tracking-middleware">Request Tracking Middleware<a class="anchor" href="#request-tracking-middleware">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># middleware/request_tracking.py - Request correlation and timing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> uuid <span style="color:#f92672">import</span> uuid4
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> Request, Response
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> starlette.middleware.base <span style="color:#f92672">import</span> BaseHTTPMiddleware
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.logging <span style="color:#f92672">import</span> request_id_var, user_id_var, log_with_context
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.requests&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestTrackingMiddleware</span>(BaseHTTPMiddleware):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Middleware for request correlation and performance tracking.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch</span>(self, request: Request, call_next):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Track request lifecycle with correlation and timing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Generate unique request ID</span>
</span></span><span style="display:flex;"><span>        request_id <span style="color:#f92672">=</span> str(uuid4())
</span></span><span style="display:flex;"><span>        request_id_var<span style="color:#f92672">.</span>set(request_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start timing</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract user ID from token if available</span>
</span></span><span style="display:flex;"><span>        user_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_extract_user_id(request)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> user_id:
</span></span><span style="display:flex;"><span>            user_id_var<span style="color:#f92672">.</span>set(user_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log request start</span>
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Request started&#34;</span>,
</span></span><span style="display:flex;"><span>            method<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>method,
</span></span><span style="display:flex;"><span>            url<span style="color:#f92672">=</span>str(request<span style="color:#f92672">.</span>url),
</span></span><span style="display:flex;"><span>            client_ip<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>host <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>client <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;unknown&#34;</span>,
</span></span><span style="display:flex;"><span>            user_agent<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user-agent&#34;</span>, <span style="color:#e6db74">&#34;unknown&#34;</span>),
</span></span><span style="display:flex;"><span>            content_length<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;content-length&#34;</span>),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Process request</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> call_next(request)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Calculate duration</span>
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log successful request</span>
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Request completed&#34;</span>,
</span></span><span style="display:flex;"><span>                status_code<span style="color:#f92672">=</span>response<span style="color:#f92672">.</span>status_code,
</span></span><span style="display:flex;"><span>                duration_ms<span style="color:#f92672">=</span>round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>                response_size<span style="color:#f92672">=</span>response<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;content-length&#34;</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Add correlation headers to response</span>
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#34;X-Request-ID&#34;</span>] <span style="color:#f92672">=</span> request_id
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Calculate duration for failed requests</span>
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log failed request</span>
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>ERROR,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Request failed&#34;</span>,
</span></span><span style="display:flex;"><span>                error_type<span style="color:#f92672">=</span>type(e)<span style="color:#f92672">.</span>__name__,
</span></span><span style="display:flex;"><span>                error_message<span style="color:#f92672">=</span>str(e),
</span></span><span style="display:flex;"><span>                duration_ms<span style="color:#f92672">=</span>round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_extract_user_id</span>(self, request: Request) <span style="color:#f92672">-&gt;</span> Optional[int]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Extract user ID from JWT token if present.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># This would integrate with your auth system</span>
</span></span><span style="display:flex;"><span>            auth_header <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;authorization&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> auth_header <span style="color:#f92672">and</span> auth_header<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;Bearer &#34;</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Decode JWT and extract user ID</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Implementation depends on your auth setup</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Don&#39;t fail requests due to user ID extraction issues</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span></span></span></code></pre></div><p><strong>Why request tracking transforms debugging:</strong></p>
<ul>
<li><strong>Request correlation</strong> - Every log entry for a single user action is connected by request ID, making it trivial to trace entire workflows</li>
<li><strong>Performance visibility</strong> - Request duration and external service timing immediately reveal performance bottlenecks</li>
<li><strong>User context</strong> - Knowing which user triggered an issue helps reproduce problems and understand impact</li>
<li><strong>Client information</strong> - User agent and IP data help identify client-specific issues or attack patterns</li>
</ul>
<h3 id="service-level-instrumentation">Service-Level Instrumentation<a class="anchor" href="#service-level-instrumentation">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># services/instrumented_user_service.py - Service layer with observability</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.logging <span style="color:#f92672">import</span> log_with_context, log_user_action, log_external_service_call
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.user_service <span style="color:#f92672">import</span> UserService <span style="color:#66d9ef">as</span> BaseUserService
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.user_service&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span>(BaseUserService):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;User service with comprehensive instrumentation.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_user</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession, 
</span></span><span style="display:flex;"><span>        user_data: UserCreate,
</span></span><span style="display:flex;"><span>        ip_address: str
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> UserPublic:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register user with full observability.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;User registration started&#34;</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>            ip_address<span style="color:#f92672">=</span>ip_address,
</span></span><span style="display:flex;"><span>            registration_method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;email&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Step 1: Check for existing user</span>
</span></span><span style="display:flex;"><span>            existing_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_check_existing_user(session, user_data<span style="color:#f92672">.</span>email)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Step 2: Create user</span>
</span></span><span style="display:flex;"><span>            user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_create_user_record(session, user_data)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Step 3: Handle side effects</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_handle_registration_side_effects(user, ip_address)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Log successful registration</span>
</span></span><span style="display:flex;"><span>            log_user_action(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;user_registered&#34;</span>,
</span></span><span style="display:flex;"><span>                user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                ip_address<span style="color:#f92672">=</span>ip_address,
</span></span><span style="display:flex;"><span>                registration_duration_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>  <span style="color:#75715e"># Would calculate actual duration</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;User registration completed successfully&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> UserPublic<span style="color:#f92672">.</span>model_validate(user)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>ERROR,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;User registration failed&#34;</span>,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                ip_address<span style="color:#f92672">=</span>ip_address,
</span></span><span style="display:flex;"><span>                error_type<span style="color:#f92672">=</span>type(e)<span style="color:#f92672">.</span>__name__,
</span></span><span style="display:flex;"><span>                error_message<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_existing_user</span>(self, session: AsyncSession, email: str) <span style="color:#f92672">-&gt;</span> Optional[User]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check for existing user with timing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            existing_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>user_repository<span style="color:#f92672">.</span>get_by_email(session, email<span style="color:#f92672">=</span>email)
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>DEBUG,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Database query: check existing user&#34;</span>,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>email,
</span></span><span style="display:flex;"><span>                duration_ms<span style="color:#f92672">=</span>round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>                found<span style="color:#f92672">=</span>existing_user <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> existing_user
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>ERROR,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Database query failed: check existing user&#34;</span>,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>email,
</span></span><span style="display:flex;"><span>                duration_ms<span style="color:#f92672">=</span>round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_handle_registration_side_effects</span>(self, user: User, ip_address: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Handle side effects with individual instrumentation.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Email sending with timing</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_send_welcome_email_instrumented(user)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Analytics tracking with timing</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_track_analytics_instrumented(user)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Audit logging with timing</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_log_audit_instrumented(user, ip_address)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_send_welcome_email_instrumented</span>(self, user: User) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send welcome email with comprehensive logging.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>send_welcome_email(user)
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_external_service_call(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;send_welcome&#34;</span>,
</span></span><span style="display:flex;"><span>                duration,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_external_service_call(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;send_welcome&#34;</span>,
</span></span><span style="display:flex;"><span>                duration,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Don&#39;t fail registration for email issues</span>
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>WARNING,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Welcome email failed but registration continues&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_track_analytics_instrumented</span>(self, user: User) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Track analytics with timing and error handling.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>track_user_registration(user)
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_external_service_call(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;analytics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;track_registration&#34;</span>,
</span></span><span style="display:flex;"><span>                duration,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_external_service_call(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;analytics&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;track_registration&#34;</span>,
</span></span><span style="display:flex;"><span>                duration,
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>WARNING,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Analytics tracking failed but registration continues&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )</span></span></code></pre></div><p><strong>Why service-level instrumentation provides operational insight:</strong></p>
<ul>
<li><strong>Business operation tracking</strong> - Every important business action is logged with context and timing</li>
<li><strong>Dependency performance</strong> - External service call timing reveals performance bottlenecks immediately</li>
<li><strong>Failure isolation</strong> - You can see exactly which step in a complex workflow failed and why</li>
<li><strong>Impact assessment</strong> - Logs show whether failures affected core operations or just side effects</li>
</ul>
<h3 id="application-metrics-collection">Application Metrics Collection<a class="anchor" href="#application-metrics-collection">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/metrics.py - Application performance metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Any, Optional
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass, field
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.metrics&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetricPoint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Individual metric measurement.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    name: str
</span></span><span style="display:flex;"><span>    value: float
</span></span><span style="display:flex;"><span>    timestamp: datetime
</span></span><span style="display:flex;"><span>    tags: Dict[str, str] <span style="color:#f92672">=</span> field(default_factory<span style="color:#f92672">=</span>dict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetricsCollector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;In-memory metrics collection for application monitoring.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics: Dict[str, list[MetricPoint]] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>counters: Dict[str, int] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>gauges: Dict[str, float] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>histograms: Dict[str, list[float]] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">increment</span>(self, name: str, value: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, tags: Optional[Dict[str, str]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Increment a counter metric.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_key(name, tags <span style="color:#f92672">or</span> {})
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>counters[key] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>counters<span style="color:#f92672">.</span>get(key, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> value
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_store_metric(MetricPoint(
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>name,
</span></span><span style="display:flex;"><span>            value<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>counters[key],
</span></span><span style="display:flex;"><span>            timestamp<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            tags<span style="color:#f92672">=</span>tags <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gauge</span>(self, name: str, value: float, tags: Optional[Dict[str, str]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Set a gauge metric value.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_key(name, tags <span style="color:#f92672">or</span> {})
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>gauges[key] <span style="color:#f92672">=</span> value
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_store_metric(MetricPoint(
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>name,
</span></span><span style="display:flex;"><span>            value<span style="color:#f92672">=</span>value,
</span></span><span style="display:flex;"><span>            timestamp<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            tags<span style="color:#f92672">=</span>tags <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">histogram</span>(self, name: str, value: float, tags: Optional[Dict[str, str]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Record a histogram value (for timing, sizes, etc.).&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_build_key(name, tags <span style="color:#f92672">or</span> {})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>histograms:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>histograms[key] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>histograms[key]<span style="color:#f92672">.</span>append(value)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>_store_metric(MetricPoint(
</span></span><span style="display:flex;"><span>            name<span style="color:#f92672">=</span>name,
</span></span><span style="display:flex;"><span>            value<span style="color:#f92672">=</span>value,
</span></span><span style="display:flex;"><span>            timestamp<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            tags<span style="color:#f92672">=</span>tags <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">timing</span>(self, name: str, duration: float, tags: Optional[Dict[str, str]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Record timing information.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>histogram(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">.duration&#34;</span>, duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, tags)  <span style="color:#75715e"># Convert to milliseconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_build_key</span>(self, name: str, tags: Dict[str, str]) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Build metric key with tags.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> tags:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> name
</span></span><span style="display:flex;"><span>        tag_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>k<span style="color:#e6db74">}</span><span style="color:#e6db74">=</span><span style="color:#e6db74">{</span>v<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> sorted(tags<span style="color:#f92672">.</span>items()))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">[</span><span style="color:#e6db74">{</span>tag_str<span style="color:#e6db74">}</span><span style="color:#e6db74">]&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_store_metric</span>(self, metric: MetricPoint) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Store metric point for reporting.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> metric<span style="color:#f92672">.</span>name <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>metrics:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>metrics[metric<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics[metric<span style="color:#f92672">.</span>name]<span style="color:#f92672">.</span>append(metric)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Keep only recent metrics (last hour)</span>
</span></span><span style="display:flex;"><span>        cutoff <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow() <span style="color:#f92672">-</span> timedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>metrics[metric<span style="color:#f92672">.</span>name] <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            m <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>metrics[metric<span style="color:#f92672">.</span>name] 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> m<span style="color:#f92672">.</span>timestamp <span style="color:#f92672">&gt;</span> cutoff
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_summary</span>(self) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get metrics summary for health checks.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        last_minute <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timedelta(minutes<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        summary <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timestamp&#34;</span>: now<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;counters&#34;</span>: dict(self<span style="color:#f92672">.</span>counters),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;gauges&#34;</span>: dict(self<span style="color:#f92672">.</span>gauges),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate histogram summaries</span>
</span></span><span style="display:flex;"><span>        histogram_summaries <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> key, values <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>histograms<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> values:
</span></span><span style="display:flex;"><span>                recent_values <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>                    v <span style="color:#66d9ef">for</span> v <span style="color:#f92672">in</span> values[<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>:]  <span style="color:#75715e"># Last 100 measurements</span>
</span></span><span style="display:flex;"><span>                ]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> recent_values:
</span></span><span style="display:flex;"><span>                    histogram_summaries[key] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;count&#34;</span>: len(recent_values),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;min&#34;</span>: min(recent_values),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;max&#34;</span>: max(recent_values),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;avg&#34;</span>: sum(recent_values) <span style="color:#f92672">/</span> len(recent_values),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;p95&#34;</span>: self<span style="color:#f92672">.</span>_percentile(recent_values, <span style="color:#ae81ff">95</span>),
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;p99&#34;</span>: self<span style="color:#f92672">.</span>_percentile(recent_values, <span style="color:#ae81ff">99</span>)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        summary[<span style="color:#e6db74">&#34;histograms&#34;</span>] <span style="color:#f92672">=</span> histogram_summaries
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> summary
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_percentile</span>(self, values: list[float], percentile: int) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Calculate percentile value.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        sorted_values <span style="color:#f92672">=</span> sorted(values)
</span></span><span style="display:flex;"><span>        index <span style="color:#f92672">=</span> int(len(sorted_values) <span style="color:#f92672">*</span> percentile <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sorted_values[min(index, len(sorted_values) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global metrics collector</span>
</span></span><span style="display:flex;"><span>metrics <span style="color:#f92672">=</span> MetricsCollector()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Metrics helpers</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">time_operation</span>(operation_name: str, tags: Optional[Dict[str, str]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Context manager for timing operations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TimingContext</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, name: str, tags: Optional[Dict[str, str]]):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>tags <span style="color:#f92672">=</span> tags <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>start_time <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__enter__</span>(self):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__exit__</span>(self, exc_type, exc_val, exc_tb):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>start_time:
</span></span><span style="display:flex;"><span>                duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>start_time
</span></span><span style="display:flex;"><span>                success <span style="color:#f92672">=</span> exc_type <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>                final_tags <span style="color:#f92672">=</span> {<span style="color:#f92672">**</span>self<span style="color:#f92672">.</span>tags, <span style="color:#e6db74">&#34;success&#34;</span>: str(success)}
</span></span><span style="display:flex;"><span>                metrics<span style="color:#f92672">.</span>timing(self<span style="color:#f92672">.</span>name, duration, final_tags)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TimingContext(operation_name, tags)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">track_user_action</span>(action: str, user_id: int, success: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Track user actions for business metrics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>increment(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;user_actions&#34;</span>,
</span></span><span style="display:flex;"><span>        tags<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;action&#34;</span>: action,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;success&#34;</span>: str(success)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> success:
</span></span><span style="display:flex;"><span>        metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_actions.success&#34;</span>, tags<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;action&#34;</span>: action})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_actions.failure&#34;</span>, tags<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;action&#34;</span>: action})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">track_external_service</span>(service: str, operation: str, duration: float, success: bool) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Track external service calls.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>timing(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;external_service.duration&#34;</span>,
</span></span><span style="display:flex;"><span>        duration,
</span></span><span style="display:flex;"><span>        tags<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;service&#34;</span>: service,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;operation&#34;</span>: operation,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;success&#34;</span>: str(success)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>increment(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;external_service.calls&#34;</span>,
</span></span><span style="display:flex;"><span>        tags<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;service&#34;</span>: service,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;operation&#34;</span>: operation,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;success&#34;</span>: str(success)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )</span></span></code></pre></div><p><strong>Why application metrics enable proactive operations:</strong></p>
<ul>
<li><strong>Performance baselines</strong> - Historical timing data helps identify when performance degrades from normal levels</li>
<li><strong>Business KPIs</strong> - User action tracking provides insight into business metrics like registration rates and feature usage</li>
<li><strong>Dependency monitoring</strong> - External service timing reveals which dependencies are slow or failing</li>
<li><strong>Capacity planning</strong> - Resource usage trends help predict when scaling is needed before problems occur</li>
</ul>
<h3 id="health-check-implementation">Health Check Implementation<a class="anchor" href="#health-check-implementation">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># routes/health.py - Comprehensive health monitoring</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> APIRouter, Depends, HTTPException
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Any
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> metrics
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.database <span style="color:#f92672">import</span> get_async_session
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.config <span style="color:#f92672">import</span> settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router <span style="color:#f92672">=</span> APIRouter(prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/health&#34;</span>, tags<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;health&#34;</span>])
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.health&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@router.get</span>(<span style="color:#e6db74">&#34;/&#34;</span>, response_model<span style="color:#f92672">=</span>Dict[str, Any])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">basic_health</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Basic health check for load balancers.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;healthy&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;timestamp&#34;</span>: datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;version&#34;</span>: settings<span style="color:#f92672">.</span>app_version
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@router.get</span>(<span style="color:#e6db74">&#34;/detailed&#34;</span>, response_model<span style="color:#f92672">=</span>Dict[str, Any])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">detailed_health</span>(
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> Depends(get_async_session)
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Detailed health check with dependency verification.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    health_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;healthy&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;timestamp&#34;</span>: datetime<span style="color:#f92672">.</span>utcnow()<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;version&#34;</span>: settings<span style="color:#f92672">.</span>app_version,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;checks&#34;</span>: {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    overall_healthy <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Database health check</span>
</span></span><span style="display:flex;"><span>    db_health <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _check_database_health(session)
</span></span><span style="display:flex;"><span>    health_data[<span style="color:#e6db74">&#34;checks&#34;</span>][<span style="color:#e6db74">&#34;database&#34;</span>] <span style="color:#f92672">=</span> db_health
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> db_health[<span style="color:#e6db74">&#34;healthy&#34;</span>]:
</span></span><span style="display:flex;"><span>        overall_healthy <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># External services health</span>
</span></span><span style="display:flex;"><span>    email_health <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _check_email_service_health()
</span></span><span style="display:flex;"><span>    health_data[<span style="color:#e6db74">&#34;checks&#34;</span>][<span style="color:#e6db74">&#34;email_service&#34;</span>] <span style="color:#f92672">=</span> email_health
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> email_health[<span style="color:#e6db74">&#34;healthy&#34;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Email failures don&#39;t make the app unhealthy, just degraded</span>
</span></span><span style="display:flex;"><span>        health_data[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;degraded&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    analytics_health <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _check_analytics_service_health()
</span></span><span style="display:flex;"><span>    health_data[<span style="color:#e6db74">&#34;checks&#34;</span>][<span style="color:#e6db74">&#34;analytics_service&#34;</span>] <span style="color:#f92672">=</span> analytics_health
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> analytics_health[<span style="color:#e6db74">&#34;healthy&#34;</span>]:
</span></span><span style="display:flex;"><span>        health_data[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;degraded&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Application metrics</span>
</span></span><span style="display:flex;"><span>    health_data[<span style="color:#e6db74">&#34;metrics&#34;</span>] <span style="color:#f92672">=</span> metrics<span style="color:#f92672">.</span>get_summary()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># System resources</span>
</span></span><span style="display:flex;"><span>    health_data[<span style="color:#e6db74">&#34;system&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _get_system_info()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> overall_healthy:
</span></span><span style="display:flex;"><span>        health_data[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;unhealthy&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> HTTPException(status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">503</span>, detail<span style="color:#f92672">=</span>health_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> health_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_database_health</span>(session) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Check database connectivity and performance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Simple query to test connectivity</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;SELECT 1&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> result<span style="color:#f92672">.</span>fetchone()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if database is responsive (&lt; 100ms for simple query)</span>
</span></span><span style="display:flex;"><span>        healthy <span style="color:#f92672">=</span> duration <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: healthy,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;connected&#34;</span> <span style="color:#66d9ef">if</span> healthy <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;slow&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Database health check failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;error&#34;</span>: str(e)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_email_service_health</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Check email service connectivity.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test SMTP connection without sending email</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> smtplib
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> smtplib<span style="color:#f92672">.</span>SMTP(settings<span style="color:#f92672">.</span>smtp_host, settings<span style="color:#f92672">.</span>smtp_port, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>) <span style="color:#66d9ef">as</span> server:
</span></span><span style="display:flex;"><span>            server<span style="color:#f92672">.</span>noop()  <span style="color:#75715e"># No-operation command to test connection</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;connected&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Email service health check failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;error&#34;</span>: str(e)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_analytics_service_health</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Check analytics service connectivity.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> httpx
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> httpx<span style="color:#f92672">.</span>AsyncClient(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">5.0</span>) <span style="color:#66d9ef">as</span> client:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Make a simple health check request to analytics service</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>settings<span style="color:#f92672">.</span>analytics_base_url<span style="color:#e6db74">}</span><span style="color:#e6db74">/health&#34;</span>)
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;connected&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Analytics service health check failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;error&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;error&#34;</span>: str(e)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_system_info</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Get basic system resource information.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> psutil
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;cpu_percent&#34;</span>: psutil<span style="color:#f92672">.</span>cpu_percent(interval<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;memory_percent&#34;</span>: psutil<span style="color:#f92672">.</span>virtual_memory()<span style="color:#f92672">.</span>percent,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;disk_percent&#34;</span>: psutil<span style="color:#f92672">.</span>disk_usage(<span style="color:#e6db74">&#39;/&#39;</span>)<span style="color:#f92672">.</span>percent,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;load_average&#34;</span>: psutil<span style="color:#f92672">.</span>getloadavg()[<span style="color:#ae81ff">0</span>]  <span style="color:#75715e"># 1-minute load average</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;psutil not available&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;System info unavailable: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@router.get</span>(<span style="color:#e6db74">&#34;/metrics&#34;</span>, response_model<span style="color:#f92672">=</span>Dict[str, Any])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_metrics</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Get application metrics for monitoring systems.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> metrics<span style="color:#f92672">.</span>get_summary()</span></span></code></pre></div><p><strong>Why comprehensive health checks enable reliable operations:</strong></p>
<ul>
<li><strong>Load balancer integration</strong> - Basic health checks ensure traffic only goes to healthy instances</li>
<li><strong>Dependency monitoring</strong> - External service health checks reveal upstream problems immediately</li>
<li><strong>Performance baselines</strong> - Response time metrics help identify degrading performance before it becomes critical</li>
<li><strong>Operational dashboards</strong> - Structured health data can be automatically graphed and alerted on</li>
</ul>
<h3 id="error-alerting-and-monitoring">Error Alerting and Monitoring<a class="anchor" href="#error-alerting-and-monitoring">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/alerting.py - Error pattern detection and alerting</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Any, List
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> collections <span style="color:#f92672">import</span> defaultdict, deque
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.alerting&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ErrorPattern</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Detected error pattern requiring attention.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    error_type: str
</span></span><span style="display:flex;"><span>    count: int
</span></span><span style="display:flex;"><span>    first_seen: datetime
</span></span><span style="display:flex;"><span>    last_seen: datetime
</span></span><span style="display:flex;"><span>    affected_users: set[int]
</span></span><span style="display:flex;"><span>    sample_errors: List[Dict[str, Any]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ErrorMonitor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Monitor error patterns and trigger alerts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>error_counts <span style="color:#f92672">=</span> defaultdict(int)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>error_history <span style="color:#f92672">=</span> defaultdict(<span style="color:#66d9ef">lambda</span>: deque(maxlen<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>user_errors <span style="color:#f92672">=</span> defaultdict(set)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>alert_cooldowns <span style="color:#f92672">=</span> {}  <span style="color:#75715e"># Prevent alert spam</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">record_error</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        error_type: str, 
</span></span><span style="display:flex;"><span>        user_id: int <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, 
</span></span><span style="display:flex;"><span>        context: Dict[str, Any] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Record error occurrence for pattern detection.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        error_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timestamp&#34;</span>: now,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;error_type&#34;</span>: error_type,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;user_id&#34;</span>: user_id,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;context&#34;</span>: context <span style="color:#f92672">or</span> {}
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Track error counts</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>error_counts[error_type] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>error_history[error_type]<span style="color:#f92672">.</span>append(error_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> user_id:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>user_errors[error_type]<span style="color:#f92672">.</span>add(user_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check for alert conditions</span>
</span></span><span style="display:flex;"><span>        asyncio<span style="color:#f92672">.</span>create_task(self<span style="color:#f92672">.</span>_check_alert_conditions(error_type))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_check_alert_conditions</span>(self, error_type: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check if error patterns warrant alerts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        recent_cutoff <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> timedelta(minutes<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get recent errors of this type</span>
</span></span><span style="display:flex;"><span>        recent_errors <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            e <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>error_history[error_type]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> e[<span style="color:#e6db74">&#34;timestamp&#34;</span>] <span style="color:#f92672">&gt;</span> recent_cutoff
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> recent_errors:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check alert conditions</span>
</span></span><span style="display:flex;"><span>        should_alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        alert_reason <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Condition 1: High error rate (&gt;10 errors in 5 minutes)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(recent_errors) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">10</span>:
</span></span><span style="display:flex;"><span>            should_alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            alert_reason <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;High error rate: </span><span style="color:#e6db74">{</span>len(recent_errors)<span style="color:#e6db74">}</span><span style="color:#e6db74"> errors in 5 minutes&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Condition 2: Multiple users affected (&gt;5 users)</span>
</span></span><span style="display:flex;"><span>        recent_users <span style="color:#f92672">=</span> {e[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> recent_errors <span style="color:#66d9ef">if</span> e[<span style="color:#e6db74">&#34;user_id&#34;</span>]}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(recent_users) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>            should_alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            alert_reason <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Multiple users affected: </span><span style="color:#e6db74">{</span>len(recent_users)<span style="color:#e6db74">}</span><span style="color:#e6db74"> users&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Condition 3: Critical error types (always alert)</span>
</span></span><span style="display:flex;"><span>        critical_errors <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;DATABASE_ERROR&#34;</span>, <span style="color:#e6db74">&#34;AUTHENTICATION_FAILURE&#34;</span>, <span style="color:#e6db74">&#34;SECURITY_VIOLATION&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> error_type <span style="color:#f92672">in</span> critical_errors:
</span></span><span style="display:flex;"><span>            should_alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            alert_reason <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Critical error: </span><span style="color:#e6db74">{</span>error_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send alert if conditions met and not in cooldown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> should_alert:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_send_alert_if_needed(error_type, alert_reason, recent_errors)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_send_alert_if_needed</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        error_type: str, 
</span></span><span style="display:flex;"><span>        reason: str, 
</span></span><span style="display:flex;"><span>        recent_errors: List[Dict[str, Any]]
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Send alert if not in cooldown period.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        cooldown_key <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>error_type<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>reason<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cooldown (don&#39;t spam alerts)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cooldown_key <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>alert_cooldowns:
</span></span><span style="display:flex;"><span>            last_alert <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>alert_cooldowns[cooldown_key]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> now <span style="color:#f92672">-</span> last_alert <span style="color:#f92672">&lt;</span> timedelta(minutes<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>  <span style="color:#75715e"># Still in cooldown</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Record alert time</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>alert_cooldowns[cooldown_key] <span style="color:#f92672">=</span> now
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create alert data</span>
</span></span><span style="display:flex;"><span>        alert_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;alert_type&#34;</span>: <span style="color:#e6db74">&#34;error_pattern&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;error_type&#34;</span>: error_type,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;reason&#34;</span>: reason,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;timestamp&#34;</span>: now<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;recent_error_count&#34;</span>: len(recent_errors),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;total_error_count&#34;</span>: self<span style="color:#f92672">.</span>error_counts[error_type],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;affected_users&#34;</span>: len({e[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> recent_errors <span style="color:#66d9ef">if</span> e[<span style="color:#e6db74">&#34;user_id&#34;</span>]}),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;sample_errors&#34;</span>: recent_errors[:<span style="color:#ae81ff">3</span>]  <span style="color:#75715e"># Include sample errors</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Send alert (in production, integrate with PagerDuty, Slack, etc.)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_dispatch_alert(alert_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_dispatch_alert</span>(self, alert_data: Dict[str, Any]) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Dispatch alert to appropriate channels.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Log alert for operators</span>
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>critical(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;ERROR ALERT: </span><span style="color:#e6db74">{</span>alert_data[<span style="color:#e6db74">&#39;reason&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>            extra<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;alert_data&#34;</span>: alert_data}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In production, send to:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># - PagerDuty for critical alerts</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># - Slack for warning alerts  </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># - Email for summary reports</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># - Dashboard for real-time monitoring</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;🚨 ALERT: </span><span style="color:#e6db74">{</span>alert_data[<span style="color:#e6db74">&#39;reason&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">{</span>alert_data[<span style="color:#e6db74">&#39;error_type&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;   Recent errors: </span><span style="color:#e6db74">{</span>alert_data[<span style="color:#e6db74">&#39;recent_error_count&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;   Affected users: </span><span style="color:#e6db74">{</span>alert_data[<span style="color:#e6db74">&#39;affected_users&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global error monitor</span>
</span></span><span style="display:flex;"><span>error_monitor <span style="color:#f92672">=</span> ErrorMonitor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Integration with exception handler</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">track_error_for_monitoring</span>(error_type: str, user_id: int <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, context: Dict[str, Any] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Track error for monitoring and alerting.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    error_monitor<span style="color:#f92672">.</span>record_error(error_type, user_id, context)</span></span></code></pre></div><p><strong>Why error monitoring enables proactive incident response:</strong></p>
<ul>
<li><strong>Pattern detection</strong> - Automatically identifies when error rates exceed normal levels, catching issues before they become critical</li>
<li><strong>User impact assessment</strong> - Tracks how many users are affected by each error type, helping prioritize response efforts</li>
<li><strong>Alert deduplication</strong> - Cooldown periods prevent alert spam while ensuring important issues aren&rsquo;t missed</li>
<li><strong>Context preservation</strong> - Sample errors provide immediate debugging context without overwhelming operators</li>
</ul>
<h2 id="observability-integration-in-service-layer">Observability Integration in Service Layer<a class="anchor" href="#observability-integration-in-service-layer">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># services/monitored_user_service.py - Complete observability integration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.logging <span style="color:#f92672">import</span> log_with_context, log_user_action
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> metrics, time_operation, track_user_action, track_external_service
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.alerting <span style="color:#f92672">import</span> track_error_for_monitoring
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;User service with complete observability integration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_user</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession, 
</span></span><span style="display:flex;"><span>        user_data: UserCreate,
</span></span><span style="display:flex;"><span>        ip_address: str
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> UserPublic:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register user with comprehensive observability.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> time_operation(<span style="color:#e6db74">&#34;user_registration&#34;</span>, {<span style="color:#e6db74">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;email&#34;</span>}):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Log registration start</span>
</span></span><span style="display:flex;"><span>                log_with_context(
</span></span><span style="display:flex;"><span>                    logger,
</span></span><span style="display:flex;"><span>                    logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;User registration started&#34;</span>,
</span></span><span style="display:flex;"><span>                    email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                    ip_address<span style="color:#f92672">=</span>ip_address
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Increment registration attempts counter</span>
</span></span><span style="display:flex;"><span>                metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_registration.attempts&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Check for existing user</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> time_operation(<span style="color:#e6db74">&#34;user_registration.check_existing&#34;</span>):
</span></span><span style="display:flex;"><span>                    existing_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>user_repository<span style="color:#f92672">.</span>get_by_email(
</span></span><span style="display:flex;"><span>                        session, email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> existing_user:
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># Track business metric</span>
</span></span><span style="display:flex;"><span>                    track_user_action(<span style="color:#e6db74">&#34;registration_duplicate&#34;</span>, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># Track for monitoring</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">await</span> track_error_for_monitoring(
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;EMAIL_ALREADY_EXISTS&#34;</span>,
</span></span><span style="display:flex;"><span>                        context<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;email&#34;</span>: user_data<span style="color:#f92672">.</span>email, <span style="color:#e6db74">&#34;ip_address&#34;</span>: ip_address}
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">raise</span> EmailAlreadyExistsError(user_data<span style="color:#f92672">.</span>email)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Create user</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> time_operation(<span style="color:#e6db74">&#34;user_registration.create_user&#34;</span>):
</span></span><span style="display:flex;"><span>                    user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>user_repository<span style="color:#f92672">.</span>create(session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Track successful creation</span>
</span></span><span style="display:flex;"><span>                track_user_action(<span style="color:#e6db74">&#34;user_created&#34;</span>, user<span style="color:#f92672">.</span>id, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>                metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_registration.success&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Handle side effects (measured individually)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_handle_monitored_side_effects(user, ip_address)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Log successful completion</span>
</span></span><span style="display:flex;"><span>                log_user_action(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;user_registered&#34;</span>,
</span></span><span style="display:flex;"><span>                    user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                    email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                    ip_address<span style="color:#f92672">=</span>ip_address
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> UserPublic<span style="color:#f92672">.</span>model_validate(user)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> EmailAlreadyExistsError:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Expected business error - track but don&#39;t alert</span>
</span></span><span style="display:flex;"><span>                metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_registration.duplicate&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Unexpected error - track for alerting</span>
</span></span><span style="display:flex;"><span>                metrics<span style="color:#f92672">.</span>increment(<span style="color:#e6db74">&#34;user_registration.error&#34;</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> track_error_for_monitoring(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;USER_REGISTRATION_ERROR&#34;</span>,
</span></span><span style="display:flex;"><span>                    context<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;email&#34;</span>: user_data<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;ip_address&#34;</span>: ip_address,
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;error&#34;</span>: str(e)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                log_with_context(
</span></span><span style="display:flex;"><span>                    logger,
</span></span><span style="display:flex;"><span>                    logging<span style="color:#f92672">.</span>ERROR,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;User registration failed unexpectedly&#34;</span>,
</span></span><span style="display:flex;"><span>                    email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email,
</span></span><span style="display:flex;"><span>                    error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_handle_monitored_side_effects</span>(self, user: User, ip_address: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Handle side effects with individual monitoring.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Email service with monitoring</span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>send_welcome_email(user)
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            track_external_service(<span style="color:#e6db74">&#34;email&#34;</span>, <span style="color:#e6db74">&#34;send_welcome&#34;</span>, duration, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            track_external_service(<span style="color:#e6db74">&#34;email&#34;</span>, <span style="color:#e6db74">&#34;send_welcome&#34;</span>, duration, <span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Track email service issues</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> track_error_for_monitoring(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;EMAIL_SERVICE_ERROR&#34;</span>,
</span></span><span style="display:flex;"><span>                user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                {<span style="color:#e6db74">&#34;operation&#34;</span>: <span style="color:#e6db74">&#34;send_welcome&#34;</span>, <span style="color:#e6db74">&#34;error&#34;</span>: str(e)}
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>WARNING,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Welcome email failed but registration continues&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Analytics service with monitoring  </span>
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>track_user_registration(user)
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            track_external_service(<span style="color:#e6db74">&#34;analytics&#34;</span>, <span style="color:#e6db74">&#34;track_registration&#34;</span>, duration, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            track_external_service(<span style="color:#e6db74">&#34;analytics&#34;</span>, <span style="color:#e6db74">&#34;track_registration&#34;</span>, duration, <span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>WARNING,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Analytics tracking failed but registration continues&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                error<span style="color:#f92672">=</span>str(e)
</span></span><span style="display:flex;"><span>            )</span></span></code></pre></div><p><strong>Why comprehensive service layer observability is transformative:</strong></p>
<ul>
<li><strong>End-to-end visibility</strong> - Every step of complex workflows is measured and logged, making debugging trivial</li>
<li><strong>Performance optimization</strong> - Individual operation timing reveals exactly which steps are slow</li>
<li><strong>Business intelligence</strong> - User action tracking provides insight into feature usage and conversion rates</li>
<li><strong>Proactive alerting</strong> - Error patterns are detected automatically before they impact large numbers of users</li>
</ul>
<h2 id="testing-observability-implementation">Testing Observability Implementation<a class="anchor" href="#testing-observability-implementation">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_observability.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> unittest.mock <span style="color:#f92672">import</span> AsyncMock, patch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> metrics
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.alerting <span style="color:#f92672">import</span> error_monitor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.monitored_user_service <span style="color:#f92672">import</span> UserService
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_registration_metrics</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test that user registration records appropriate metrics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reset metrics for clean test</span>
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>counters<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>histograms<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Setup service with mocks</span>
</span></span><span style="display:flex;"><span>    user_repository <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>    email_service <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>    analytics_service <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    user_repository<span style="color:#f92672">.</span>create<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>        id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>, full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    service <span style="color:#f92672">=</span> UserService(
</span></span><span style="display:flex;"><span>        user_repository<span style="color:#f92672">=</span>user_repository,
</span></span><span style="display:flex;"><span>        email_service<span style="color:#f92672">=</span>email_service,
</span></span><span style="display:flex;"><span>        analytics_service<span style="color:#f92672">=</span>analytics_service
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Perform registration</span>
</span></span><span style="display:flex;"><span>    user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>        email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>        full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>        password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password123&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> service<span style="color:#f92672">.</span>register_user(session, user_data, <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify metrics were recorded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;user_registration.attempts&#34;</span> <span style="color:#f92672">in</span> [
</span></span><span style="display:flex;"><span>        key<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;[&#39;</span>)[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> metrics<span style="color:#f92672">.</span>counters<span style="color:#f92672">.</span>keys()
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;user_registration.success&#34;</span> <span style="color:#f92672">in</span> [
</span></span><span style="display:flex;"><span>        key<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;[&#39;</span>)[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> metrics<span style="color:#f92672">.</span>counters<span style="color:#f92672">.</span>keys()
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify timing metrics were recorded</span>
</span></span><span style="display:flex;"><span>    timing_metrics <span style="color:#f92672">=</span> [key <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> metrics<span style="color:#f92672">.</span>histograms<span style="color:#f92672">.</span>keys() <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;duration&#34;</span> <span style="color:#f92672">in</span> key]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(timing_metrics) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_error_monitoring_triggers_alerts</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test that error patterns trigger appropriate alerts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reset error monitor</span>
</span></span><span style="display:flex;"><span>    error_monitor<span style="color:#f92672">.</span>error_counts<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    error_monitor<span style="color:#f92672">.</span>error_history<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Record multiple errors of the same type</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">12</span>):  <span style="color:#75715e"># Exceeds alert threshold of 10</span>
</span></span><span style="display:flex;"><span>        error_monitor<span style="color:#f92672">.</span>record_error(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;EMAIL_SERVICE_ERROR&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>i,
</span></span><span style="display:flex;"><span>            context<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;attempt&#34;</span>: i}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Allow async alert processing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify error was recorded</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> error_monitor<span style="color:#f92672">.</span>error_counts[<span style="color:#e6db74">&#34;EMAIL_SERVICE_ERROR&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># In a real test, you would verify that alerts were sent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This would involve mocking the alert dispatch mechanism</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_structured_logging_includes_context</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test that structured logging includes proper context.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> patch(<span style="color:#e6db74">&#39;neodyme.core.logging.logger&#39;</span>) <span style="color:#66d9ef">as</span> mock_logger:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup service</span>
</span></span><span style="display:flex;"><span>        user_repository <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>        email_service <span style="color:#f92672">=</span> AsyncMock()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make email service fail</span>
</span></span><span style="display:flex;"><span>        email_service<span style="color:#f92672">.</span>send_welcome_email<span style="color:#f92672">.</span>side_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;SMTP Error&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        service <span style="color:#f92672">=</span> UserService(
</span></span><span style="display:flex;"><span>            user_repository<span style="color:#f92672">=</span>user_repository,
</span></span><span style="display:flex;"><span>            email_service<span style="color:#f92672">=</span>email_service,
</span></span><span style="display:flex;"><span>            analytics_service<span style="color:#f92672">=</span>AsyncMock()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try registration (should handle email failure gracefully)</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password123&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> service<span style="color:#f92672">.</span>register_user(AsyncMock(), user_data, <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify structured logging was called with context</span>
</span></span><span style="display:flex;"><span>        warning_calls <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            call <span style="color:#66d9ef">for</span> call <span style="color:#f92672">in</span> mock_logger<span style="color:#f92672">.</span>warning<span style="color:#f92672">.</span>call_args_list
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;Welcome email failed&#34;</span> <span style="color:#f92672">in</span> str(call)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(warning_calls) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_health_check_detects_issues</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test that health checks properly detect service issues.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.routes.health <span style="color:#f92672">import</span> _check_email_service_health
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Mock SMTP connection failure</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> patch(<span style="color:#e6db74">&#39;smtplib.SMTP&#39;</span>) <span style="color:#66d9ef">as</span> mock_smtp:
</span></span><span style="display:flex;"><span>        mock_smtp<span style="color:#f92672">.</span>side_effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;Connection refused&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        health_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _check_email_service_health()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> health_result[<span style="color:#e6db74">&#34;healthy&#34;</span>] <span style="color:#f92672">is</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> health_result
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> health_result[<span style="color:#e6db74">&#34;status&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;error&#34;</span></span></span></code></pre></div><p><strong>Why testing observability is crucial:</strong></p>
<ul>
<li><strong>Metric accuracy</strong> - Tests ensure that business metrics accurately reflect actual operations</li>
<li><strong>Alert reliability</strong> - Tests verify that alert conditions trigger appropriately without false positives</li>
<li><strong>Log completeness</strong> - Tests confirm that error scenarios include sufficient context for debugging</li>
<li><strong>Health check validity</strong> - Tests ensure health checks accurately reflect service status</li>
</ul>
<h2 id="what-youve-learned">What You&rsquo;ve Learned<a class="anchor" href="#what-youve-learned">#</a></h2>
<p>By the end of this chapter, you understand:</p>
<p>✅ <strong>Why basic logging creates debugging nightmares</strong> - and how structured logging with correlation IDs makes debugging exponentially faster<br>
✅ <strong>How comprehensive metrics enable proactive operations</strong> - providing visibility into performance trends and business KPIs before problems become critical<br>
✅ <strong>Why request tracking transforms production debugging</strong> - connecting all log entries for a user action makes complex issue investigation trivial<br>
✅ <strong>How error monitoring enables proactive incident response</strong> - automatically detecting patterns and alerting on issues before they impact large numbers of users<br>
✅ <strong>Why health checks enable reliable operations</strong> - ensuring load balancers and monitoring systems understand actual application health<br>
✅ <strong>How observability integration provides end-to-end visibility</strong> - making every aspect of your application self-documenting and measurable</p>
<p>More importantly, you&rsquo;ve built observability that transforms your application from a black box into a system that explains its own behavior, enabling rapid debugging and proactive operations.</p>
<h2 id="building-blocks-for-next-chapters">Building Blocks for Next Chapters<a class="anchor" href="#building-blocks-for-next-chapters">#</a></h2>
<p>This observability foundation gives us:</p>
<ul>
<li><strong>HTTP handling</strong> ← Chapter 1: FastAPI basics</li>
<li><strong>Data persistence</strong> ← Chapter 2: Database integration</li>
<li><strong>Input validation</strong> ← Chapter 3: Request/response validation</li>
<li><strong>Schema evolution</strong> ← Chapter 4: Database migrations</li>
<li><strong>Clean architecture</strong> ← Chapter 5: Service layer organization</li>
<li><strong>Error handling</strong> ← Chapter 6: Professional error management</li>
<li><strong>Security</strong> ← Chapter 7: Authentication and authorization</li>
<li><strong>Configuration</strong> ← Chapter 8: Environment management</li>
<li><strong>Testing</strong> ← Chapter 9: Comprehensive test strategies</li>
<li><strong>Deployment</strong> ← Chapter 10: Production deployment</li>
<li><strong>Observability</strong> ← You are here</li>
<li><strong>Scaling</strong> ← Chapter 12: Performance and scaling</li>
</ul>
<h2 id="exercises">Exercises<a class="anchor" href="#exercises">#</a></h2>
<ol>
<li><strong>Add custom metrics</strong> - Implement business-specific metrics for your domain (e.g., conversion rates, feature usage)</li>
<li><strong>Create alert rules</strong> - Build alert conditions for different error types and business scenarios</li>
<li><strong>Implement distributed tracing</strong> - Add trace IDs that follow requests across multiple services</li>
<li><strong>Build monitoring dashboards</strong> - Create real-time dashboards showing key application metrics</li>
<li><strong>Add performance profiling</strong> - Implement code-level performance monitoring to identify optimization opportunities</li>
</ol>
<h2 id="resources-for-deeper-learning">Resources for Deeper Learning<a class="anchor" href="#resources-for-deeper-learning">#</a></h2>
<h3 id="observability-fundamentals">Observability Fundamentals<a class="anchor" href="#observability-fundamentals">#</a></h3>
<ul>
<li><strong>Observability Engineering</strong>: Comprehensive guide to observability practices - <a href="https://www.honeycomb.io/blog/observability-engineering-101/">https://www.honeycomb.io/blog/observability-engineering-101/</a></li>
<li><strong>The Three Pillars of Observability</strong>: Logs, metrics, and traces explained - <a href="https://peter.bourgon.org/blog/2017/02/21/metrics-tracing-and-logging.html">https://peter.bourgon.org/blog/2017/02/21/metrics-tracing-and-logging.html</a></li>
<li><strong>SRE Monitoring and Observability</strong>: Google&rsquo;s approach to production monitoring - <a href="https://sre.google/sre-book/monitoring-distributed-systems/">https://sre.google/sre-book/monitoring-distributed-systems/</a></li>
</ul>
<h3 id="structured-logging">Structured Logging<a class="anchor" href="#structured-logging">#</a></h3>
<ul>
<li><strong>Structured Logging Best Practices</strong>: Making logs machine-readable and useful - <a href="https://www.honeycomb.io/blog/structured-logging-and-your-team/">https://www.honeycomb.io/blog/structured-logging-and-your-team/</a></li>
<li><strong>Python Logging Configuration</strong>: Advanced logging setup patterns - <a href="https://realpython.com/python-logging/">https://realpython.com/python-logging/</a></li>
<li><strong>JSON Logging Standards</strong>: Standardized log formats for better tooling - <a href="https://www.elastic.co/guide/en/ecs/current/index.html">https://www.elastic.co/guide/en/ecs/current/index.html</a></li>
</ul>
<h3 id="metrics-and-monitoring">Metrics and Monitoring<a class="anchor" href="#metrics-and-monitoring">#</a></h3>
<ul>
<li><strong>Prometheus Monitoring</strong>: Industry-standard metrics collection - <a href="https://prometheus.io/docs/introduction/overview/">https://prometheus.io/docs/introduction/overview/</a></li>
<li><strong>RED Method</strong>: Rate, Errors, Duration metrics for service monitoring - <a href="https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/">https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/</a></li>
<li><strong>USE Method</strong>: Utilization, Saturation, Errors for resource monitoring - <a href="http://www.brendangregg.com/usemethod.html">http://www.brendangregg.com/usemethod.html</a></li>
</ul>
<h3 id="production-debugging">Production Debugging<a class="anchor" href="#production-debugging">#</a></h3>
<ul>
<li><strong>Distributed Tracing</strong>: Following requests across service boundaries - <a href="https://opentracing.io/docs/overview/what-is-tracing/">https://opentracing.io/docs/overview/what-is-tracing/</a></li>
<li><strong>Error Tracking</strong>: Effective error monitoring and alerting - <a href="https://sentry.io/for/error-monitoring/">https://sentry.io/for/error-monitoring/</a></li>
<li><strong>Performance Monitoring</strong>: Application performance management patterns - <a href="https://newrelic.com/platform/application-monitoring">https://newrelic.com/platform/application-monitoring</a></li>
</ul>
<h3 id="why-these-resources-matter">Why These Resources Matter<a class="anchor" href="#why-these-resources-matter">#</a></h3>
<ul>
<li><strong>Observability principles</strong>: Understanding the theory behind observability helps you implement it effectively</li>
<li><strong>Structured data</strong>: Learning structured logging and metrics enables building powerful monitoring tooling</li>
<li><strong>Production practices</strong>: SRE and DevOps practices provide proven patterns for reliable operations</li>
<li><strong>Tooling integration</strong>: Understanding how observability tools work helps you choose and configure them effectively</li>
</ul>
<p><strong>Pro Tip</strong>: Start with structured logging and basic metrics, then add distributed tracing and advanced alerting as your system grows in complexity.</p>
<h2 id="next-scaling-beyond-one-machine">Next: Scaling Beyond One Machine<a class="anchor" href="#next-scaling-beyond-one-machine">#</a></h2>
<p>You have comprehensive observability that shows exactly how your application is performing, but now you&rsquo;re facing a new challenge: success. Your user base is growing, request volumes are increasing, and single-server deployment isn&rsquo;t enough anymore.</p>
<p>In Chapter 12, we&rsquo;ll explore scaling patterns that handle real-world load while maintaining the reliability and observability you&rsquo;ve built.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Preview of Chapter 12</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CacheService</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;High-performance caching for frequently accessed data.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_user_profile</span>(self, user_id: int) <span style="color:#f92672">-&gt;</span> Optional[UserProfile]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get user profile with multi-layer caching.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check in-memory cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check Redis cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fall back to database</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update caches appropriately</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BackgroundJobProcessor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Async job processing for long-running operations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">queue_welcome_email</span>(self, user_id: int) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Queue email sending as background job.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add job to queue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Return job ID for tracking</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Process asynchronously</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span></span></span></code></pre></div><p>We&rsquo;ll explore how to build applications that scale horizontally while maintaining the clean architecture and comprehensive observability you&rsquo;ve established.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/neodyme/docs/chapter-10/" class="flex align-center">
        <img src="/neodyme/icons/backward.svg" class="book-icon" alt="Previous" title="Chapter 10" />
        <span>Chapter 10</span>
      </a>
    
    </span>
    <span>
    
      <a href="/neodyme/docs/chapter-12/" class="flex align-center">
        <span>Chapter 12</span>
        <img src="/neodyme/icons/forward.svg" class="book-icon" alt="Next" title="Chapter 12" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        
        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-production-applications-as-black-boxes">The Problem: Production Applications as Black Boxes</a></li>
    <li><a href="#why-basic-monitoring-isnt-enough">Why Basic Monitoring Isn&rsquo;t Enough</a></li>
    <li><a href="#the-observability-solution-applications-that-explain-themselves">The Observability Solution: Applications That Explain Themselves</a>
      <ul>
        <li><a href="#structured-logging-making-logs-machine-readable">Structured Logging: Making Logs Machine-Readable</a></li>
        <li><a href="#request-tracking-middleware">Request Tracking Middleware</a></li>
        <li><a href="#service-level-instrumentation">Service-Level Instrumentation</a></li>
        <li><a href="#application-metrics-collection">Application Metrics Collection</a></li>
        <li><a href="#health-check-implementation">Health Check Implementation</a></li>
        <li><a href="#error-alerting-and-monitoring">Error Alerting and Monitoring</a></li>
      </ul>
    </li>
    <li><a href="#observability-integration-in-service-layer">Observability Integration in Service Layer</a></li>
    <li><a href="#testing-observability-implementation">Testing Observability Implementation</a></li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-for-next-chapters">Building Blocks for Next Chapters</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#observability-fundamentals">Observability Fundamentals</a></li>
        <li><a href="#structured-logging">Structured Logging</a></li>
        <li><a href="#metrics-and-monitoring">Metrics and Monitoring</a></li>
        <li><a href="#production-debugging">Production Debugging</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#next-scaling-beyond-one-machine">Next: Scaling Beyond One Machine</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>


















