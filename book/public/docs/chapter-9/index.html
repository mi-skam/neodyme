<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Chapter 9: &ldquo;I Need Tests That Give Me Confidence&rdquo;#
Your neodyme application has solid architecture, professional error handling, and bulletproof configuration management. But now you&rsquo;re facing a developer&rsquo;s eternal dilemma: How do you know your code actually works?
You&rsquo;ve probably written some tests, but they fall into one of these categories: tests so slow you avoid running them, tests so brittle they break when you refactor, or tests so shallow they pass while your application has obvious bugs. Each failed deployment teaches you that your test suite isn&rsquo;t giving you the confidence you need.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://mi-skam.github.io/neodyme/docs/chapter-9/">
  <meta property="og:site_name" content="Neodyme Documentation">
  <meta property="og:title" content="Chapter 9">
  <meta property="og:description" content="Chapter 9: “I Need Tests That Give Me Confidence”# Your neodyme application has solid architecture, professional error handling, and bulletproof configuration management. But now you’re facing a developer’s eternal dilemma: How do you know your code actually works?
You’ve probably written some tests, but they fall into one of these categories: tests so slow you avoid running them, tests so brittle they break when you refactor, or tests so shallow they pass while your application has obvious bugs. Each failed deployment teaches you that your test suite isn’t giving you the confidence you need.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Chapter 9 | Neodyme Documentation</title>
<link rel="icon" href="/neodyme/favicon.png" >
<link rel="manifest" href="/neodyme/manifest.json">
<link rel="canonical" href="https://mi-skam.github.io/neodyme/docs/chapter-9/">
<link rel="stylesheet" href="/neodyme/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/neodyme/fuse.min.js"></script>
  <script defer src="/neodyme/en.search.min.f64f4d2b3193917ebd07e82190bf6e6a2f23d6e670fb678260875bd442e5cf4d.js" integrity="sha256-9k9NKzGTkX69B&#43;ghkL9uai8j1uZw&#43;2eCYIdb1ELlz00=" crossorigin="anonymous"></script>

  
</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/neodyme/"><span>Neodyme Documentation</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>














  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-1/" class="">
      Chapter 1</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-2/" class="">
      Chapter 2</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-3/" class="">
      Chapter 3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-4/" class="">
      Chapter 4</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-5/" class="">
      Chapter 5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-6/" class="">
      Chapter 6</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-7/" class="">
      Chapter 7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-8/" class="">
      Chapter 8</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-9/" class="active">
      Chapter 9</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-10/" class="">
      Chapter 10</a>
  

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/neodyme/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Chapter 9</h3>

  <label for="toc-control">
    
    <img src="/neodyme/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-tests-that-dont-test-anything-useful">The Problem: Tests That Don&rsquo;t Test Anything Useful</a></li>
    <li><a href="#why-fast-tests-vs-slow-tests-is-the-wrong-question">Why Fast Tests vs Slow Tests Is the Wrong Question</a></li>
    <li><a href="#the-professional-testing-solution-behavior-driven-confidence">The Professional Testing Solution: Behavior-Driven Confidence</a></li>
    <li><a href="#unit-testing-with-real-database-integration">Unit Testing with Real Database Integration</a></li>
    <li><a href="#service-layer-testing-with-mock-integration">Service Layer Testing with Mock Integration</a></li>
    <li><a href="#api-integration-testing">API Integration Testing</a></li>
    <li><a href="#performance-and-load-testing">Performance and Load Testing</a></li>
    <li><a href="#test-organization-and-best-practices">Test Organization and Best Practices</a></li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-for-next-chapters">Building Blocks for Next Chapters</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#testing-fundamentals">Testing Fundamentals</a></li>
        <li><a href="#async-and-database-testing">Async and Database Testing</a></li>
        <li><a href="#advanced-testing-techniques">Advanced Testing Techniques</a></li>
        <li><a href="#test-organization-and-maintenance">Test Organization and Maintenance</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#next-production-ready-deployment">Next: Production-Ready Deployment</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="chapter-9-i-need-tests-that-give-me-confidence">Chapter 9: &ldquo;I Need Tests That Give Me Confidence&rdquo;<a class="anchor" href="#chapter-9-i-need-tests-that-give-me-confidence">#</a></h1>
<p>Your neodyme application has solid architecture, professional error handling, and bulletproof configuration management. But now you&rsquo;re facing a developer&rsquo;s eternal dilemma: How do you know your code actually works?</p>
<p>You&rsquo;ve probably written some tests, but they fall into one of these categories: tests so slow you avoid running them, tests so brittle they break when you refactor, or tests so shallow they pass while your application has obvious bugs. Each failed deployment teaches you that your test suite isn&rsquo;t giving you the confidence you need.</p>
<p>This is the moment every growing codebase faces: <strong>code without reliable tests is code you&rsquo;re afraid to change</strong>. The question isn&rsquo;t whether you should write tests—it&rsquo;s whether your tests will help you ship faster or slow you down with false confidence and maintenance overhead.</p>
<h2 id="the-problem-tests-that-dont-test-anything-useful">The Problem: Tests That Don&rsquo;t Test Anything Useful<a class="anchor" href="#the-problem-tests-that-dont-test-anything-useful">#</a></h2>
<p>Let me ask you: Have you ever had a test suite with 90% coverage that still missed obvious bugs? If so, you&rsquo;ve experienced the difference between having tests and having valuable tests.</p>
<p>Here&rsquo;s what testing typically looks like when it&rsquo;s an afterthought:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># What looks like testing but provides no confidence</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserRepository</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_create_user</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user creation.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;test@example.com&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Test User&#34;</span>}
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> UserRepository<span style="color:#f92672">.</span>create(user_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This test tells us nothing about whether users are actually stored!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserService</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_register_user</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        service <span style="color:#f92672">=</span> UserService()
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> service<span style="color:#f92672">.</span>register_user(<span style="color:#e6db74">&#34;email@test.com&#34;</span>, <span style="color:#e6db74">&#34;password&#34;</span>, <span style="color:#e6db74">&#34;Name&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> result <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Doesn&#39;t test email sending, password hashing, database storage, or error handling!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserEndpoint</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_create_user_endpoint</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user creation endpoint.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/users&#34;</span>, json<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;test@test.com&#34;</span>})
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Doesn&#39;t verify the user was actually created or that the response is correct!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># These tests pass but don&#39;t verify:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Database transactions work correctly</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Password hashing happens</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Email validation works  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Error handling responds appropriately</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Side effects (emails, analytics) occur</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Business rules are enforced</span></span></span></code></pre></div><p><strong>Why these tests provide false confidence:</strong></p>
<ul>
<li><strong>Unit testing in isolation</strong> - Tests verify method calls return values but don&rsquo;t test integration with real dependencies like databases</li>
<li><strong>Happy path bias</strong> - Tests only verify success scenarios while ignoring error conditions that are common in production</li>
<li><strong>Mock everything mentality</strong> - Heavy mocking means tests verify interactions with mocks rather than actual behavior</li>
<li><strong>Missing edge cases</strong> - Tests don&rsquo;t cover boundary conditions, concurrent access, or realistic data scenarios</li>
<li><strong>No end-to-end validation</strong> - Tests verify individual components work but not that the complete workflow functions correctly</li>
<li><strong>Brittle test structure</strong> - Tests break whenever implementation details change, even when behavior remains correct</li>
</ul>
<p>The fundamental problem is <strong>testing implementation instead of behavior</strong>. These tests verify that code executes without checking whether it produces the right results.</p>
<h2 id="why-fast-tests-vs-slow-tests-is-the-wrong-question">Why Fast Tests vs Slow Tests Is the Wrong Question<a class="anchor" href="#why-fast-tests-vs-slow-tests-is-the-wrong-question">#</a></h2>
<p>The common testing advice creates a false dilemma:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># &#34;Fast&#34; unit tests that don&#39;t test real behavior</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_password_hashing</span>():
</span></span><span style="display:flex;"><span>    hasher <span style="color:#f92672">=</span> PasswordHasher()
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> hasher<span style="color:#f92672">.</span>hash_password(<span style="color:#e6db74">&#34;password123&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> result <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;password123&#34;</span>  <span style="color:#75715e"># Tells us almost nothing!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &#34;Slow&#34; integration tests that test everything</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_registration_full_stack</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Spins up database, email server, analytics service...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Takes 30 seconds to run</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Breaks when any external service changes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Too slow to run during development</span></span></span></code></pre></div><p><strong>This approach fails because:</strong></p>
<ul>
<li><strong>False speed optimization</strong> - Fast tests that don&rsquo;t catch bugs aren&rsquo;t actually helping development speed</li>
<li><strong>Integration avoidance</strong> - Developers avoid writing integration tests because they&rsquo;re perceived as slow and complex</li>
<li><strong>Coverage theater</strong> - High unit test coverage provides false confidence while integration bugs slip through</li>
<li><strong>Development workflow breakdown</strong> - Slow tests can&rsquo;t be run frequently, so bugs are discovered late in the development cycle</li>
<li><strong>Production surprises</strong> - Code that passes isolated unit tests still fails when components interact in production</li>
</ul>
<h2 id="the-professional-testing-solution-behavior-driven-confidence">The Professional Testing Solution: Behavior-Driven Confidence<a class="anchor" href="#the-professional-testing-solution-behavior-driven-confidence">#</a></h2>
<p>Professional testing focuses on verifying behavior rather than implementation, using the right testing tools for each scenario. Here&rsquo;s how neodyme implements comprehensive testing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/conftest.py - Comprehensive test setup</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> AsyncGenerator, Generator
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.asyncio <span style="color:#f92672">import</span> AsyncSession, create_async_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.pool <span style="color:#f92672">import</span> StaticPool
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> httpx <span style="color:#f92672">import</span> AsyncClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> testcontainers.postgres <span style="color:#f92672">import</span> PostgresContainer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.main <span style="color:#f92672">import</span> app
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.config <span style="color:#f92672">import</span> Settings, Environment
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.database <span style="color:#f92672">import</span> get_async_session
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.models <span style="color:#f92672">import</span> SQLModel
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.email_service <span style="color:#f92672">import</span> MockEmailService
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.analytics_service <span style="color:#f92672">import</span> MockAnalyticsService
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test configuration</span>
</span></span><span style="display:flex;"><span>TEST_SETTINGS <span style="color:#f92672">=</span> Settings(
</span></span><span style="display:flex;"><span>    environment<span style="color:#f92672">=</span>Environment<span style="color:#f92672">.</span>TESTING,
</span></span><span style="display:flex;"><span>    database_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;postgresql+asyncpg://test:test@localhost:5433/test_db&#34;</span>,
</span></span><span style="display:flex;"><span>    secret_key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test-secret-key-32-characters-long&#34;</span>,
</span></span><span style="display:flex;"><span>    email_smtp_host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost&#34;</span>,
</span></span><span style="display:flex;"><span>    email_smtp_port<span style="color:#f92672">=</span><span style="color:#ae81ff">1025</span>,
</span></span><span style="display:flex;"><span>    email_smtp_username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>    email_smtp_password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>    email_from_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@neodyme.test&#34;</span>,
</span></span><span style="display:flex;"><span>    debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;WARNING&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>(scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;session&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">event_loop</span>() <span style="color:#f92672">-&gt;</span> Generator[asyncio<span style="color:#f92672">.</span>AbstractEventLoop, <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Create event loop for async tests.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop_policy()<span style="color:#f92672">.</span>new_event_loop()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> loop
</span></span><span style="display:flex;"><span>    loop<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>(scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;session&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">postgres_container</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Start PostgreSQL container for testing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> PostgresContainer(<span style="color:#e6db74">&#34;postgres:15&#34;</span>) <span style="color:#66d9ef">as</span> postgres:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> postgres
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>(scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;session&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_engine</span>(postgres_container):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Create test database engine.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    database_url <span style="color:#f92672">=</span> postgres_container<span style="color:#f92672">.</span>get_connection_url()<span style="color:#f92672">.</span>replace(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;postgresql://&#34;</span>, <span style="color:#e6db74">&#34;postgresql+asyncpg://&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    engine <span style="color:#f92672">=</span> create_async_engine(
</span></span><span style="display:flex;"><span>        database_url,
</span></span><span style="display:flex;"><span>        poolclass<span style="color:#f92672">=</span>StaticPool,
</span></span><span style="display:flex;"><span>        echo<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create all tables</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> engine<span style="color:#f92672">.</span>begin() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> conn<span style="color:#f92672">.</span>run_sync(SQLModel<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> engine
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Cleanup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> engine<span style="color:#f92672">.</span>dispose()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_session</span>(test_engine) <span style="color:#f92672">-&gt;</span> AsyncGenerator[AsyncSession, <span style="color:#66d9ef">None</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Create isolated test database session.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> AsyncSession(test_engine, expire_on_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Start transaction</span>
</span></span><span style="display:flex;"><span>        transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>begin()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> session
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Rollback transaction to isolate tests</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> transaction<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_client</span>(test_session) <span style="color:#f92672">-&gt;</span> AsyncGenerator[AsyncClient, <span style="color:#66d9ef">None</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Create test client with dependency overrides.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Override database session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">override_get_session</span>():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> test_session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>dependency_overrides[get_async_session] <span style="color:#f92672">=</span> override_get_session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Override services with test implementations</span>
</span></span><span style="display:flex;"><span>    test_email_service <span style="color:#f92672">=</span> MockEmailService()
</span></span><span style="display:flex;"><span>    test_analytics_service <span style="color:#f92672">=</span> MockAnalyticsService()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>dependency_overrides[get_email_service] <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span>: test_email_service
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>dependency_overrides[get_analytics_service] <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span>: test_analytics_service
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> AsyncClient(app<span style="color:#f92672">=</span>app, base_url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://test&#34;</span>) <span style="color:#66d9ef">as</span> client:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store service references for test verification</span>
</span></span><span style="display:flex;"><span>        client<span style="color:#f92672">.</span>email_service <span style="color:#f92672">=</span> test_email_service
</span></span><span style="display:flex;"><span>        client<span style="color:#f92672">.</span>analytics_service <span style="color:#f92672">=</span> test_analytics_service
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> client
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Clean up overrides</span>
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>dependency_overrides<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sample_user_data</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Sample user data for testing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;SecurePassword123!&#34;</span>
</span></span><span style="display:flex;"><span>    }</span></span></code></pre></div><p><strong>Why this test setup provides reliable testing:</strong></p>
<ul>
<li><strong>Real database testing</strong> - Uses PostgreSQL container to test against the same database type as production</li>
<li><strong>Transaction isolation</strong> - Each test runs in its own transaction that&rsquo;s rolled back, ensuring test independence</li>
<li><strong>Service mocking</strong> - External services are mocked but with implementations that track calls for verification</li>
<li><strong>Fast test execution</strong> - Database setup happens once per session, individual tests run quickly with transaction rollback</li>
<li><strong>Production-like environment</strong> - Tests run against the same application code that runs in production</li>
</ul>
<h2 id="unit-testing-with-real-database-integration">Unit Testing with Real Database Integration<a class="anchor" href="#unit-testing-with-real-database-integration">#</a></h2>
<p>Unit tests should verify business logic while using real database operations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_repositories.py - Repository layer testing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.exc <span style="color:#f92672">import</span> IntegrityError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.repositories.user_repository <span style="color:#f92672">import</span> UserRepository
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.models <span style="color:#f92672">import</span> User, UserCreate, UserUpdate
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.exceptions <span style="color:#f92672">import</span> EmailAlreadyExistsError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserRepository</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test user repository with real database operations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">user_repository</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create user repository instance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> UserRepository()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_create_user_success</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test successful user creation with database persistence.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;SecurePassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create user</span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify user was created with correct data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>id <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>full_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Test User&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>hashed_password <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;SecurePassword123!&#34;</span>  <span style="color:#75715e"># Password should be hashed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>hashed_password<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;$2b$&#34;</span>)  <span style="color:#75715e"># Bcrypt format</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>is_active <span style="color:#f92672">is</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> isinstance(user<span style="color:#f92672">.</span>created_at, datetime)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> isinstance(user<span style="color:#f92672">.</span>updated_at, datetime)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify user exists in database</span>
</span></span><span style="display:flex;"><span>        retrieved_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get(test_session, id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> retrieved_user <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> retrieved_user<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> user<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_create_user_duplicate_email</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that duplicate email creation raises appropriate error.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;duplicate@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;First User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create first user</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> test_session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Attempt to create second user with same email</span>
</span></span><span style="display:flex;"><span>        duplicate_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;duplicate@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Second User&#34;</span>, 
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Different123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(EmailAlreadyExistsError) <span style="color:#66d9ef">as</span> exc_info:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>duplicate_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify error details</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> exc_info<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;duplicate@example.com&#34;</span> <span style="color:#f92672">in</span> error<span style="color:#f92672">.</span>message
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;duplicate@example.com&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_get_by_email</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test retrieving user by email.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create test user</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;lookup@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Lookup User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        created_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> test_session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test successful lookup</span>
</span></span><span style="display:flex;"><span>        found_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get_by_email(test_session, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;lookup@example.com&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> found_user <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> found_user<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> created_user<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> found_user<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lookup@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Test lookup with non-existent email</span>
</span></span><span style="display:flex;"><span>        not_found <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get_by_email(test_session, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nonexistent@example.com&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> not_found <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_update_user</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user update operations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create user</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;update@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Original Name&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        original_updated_at <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>updated_at
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait to ensure timestamp difference</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update user</span>
</span></span><span style="display:flex;"><span>        update_data <span style="color:#f92672">=</span> UserUpdate(full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Updated Name&#34;</span>)
</span></span><span style="display:flex;"><span>        updated_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>update(
</span></span><span style="display:flex;"><span>            test_session, 
</span></span><span style="display:flex;"><span>            db_obj<span style="color:#f92672">=</span>user, 
</span></span><span style="display:flex;"><span>            obj_in<span style="color:#f92672">=</span>update_data
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify update</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> updated_user<span style="color:#f92672">.</span>full_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Updated Name&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> updated_user<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;update@example.com&#34;</span>  <span style="color:#75715e"># Unchanged</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> updated_user<span style="color:#f92672">.</span>updated_at <span style="color:#f92672">&gt;</span> original_updated_at
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify persistence</span>
</span></span><span style="display:flex;"><span>        retrieved_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get(test_session, id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> retrieved_user<span style="color:#f92672">.</span>full_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Updated Name&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_delete_user</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user deletion.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create user</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;delete@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Delete User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        user_id <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> test_session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify user exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get(test_session, id<span style="color:#f92672">=</span>user_id) <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Delete user</span>
</span></span><span style="display:flex;"><span>        deleted_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>delete(test_session, id<span style="color:#f92672">=</span>user_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> deleted_user<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> user_id
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify user no longer exists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get(test_session, id<span style="color:#f92672">=</span>user_id) <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_password_verification</span>(self, test_session, user_repository):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test password hashing and verification.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;TestPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span>password
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>create(test_session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify password is hashed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user<span style="color:#f92672">.</span>hashed_password <span style="color:#f92672">!=</span> password
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify password verification works</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user_repository<span style="color:#f92672">.</span>verify_password(password, user<span style="color:#f92672">.</span>hashed_password)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#f92672">not</span> user_repository<span style="color:#f92672">.</span>verify_password(<span style="color:#e6db74">&#34;wrong_password&#34;</span>, user<span style="color:#f92672">.</span>hashed_password)</span></span></code></pre></div><p><strong>Why database-integrated unit tests are valuable:</strong></p>
<ul>
<li><strong>Real persistence verification</strong> - Tests confirm that data is actually saved to and retrieved from the database correctly</li>
<li><strong>Constraint validation</strong> - Database constraints (like unique email) are tested with real database behavior</li>
<li><strong>Type conversion testing</strong> - Tests verify that Pydantic models convert to/from database types correctly</li>
<li><strong>Transaction behavior</strong> - Tests can verify transaction isolation and rollback behavior</li>
<li><strong>Performance insights</strong> - Tests reveal actual database query performance and N+1 query problems</li>
</ul>
<h2 id="service-layer-testing-with-mock-integration">Service Layer Testing with Mock Integration<a class="anchor" href="#service-layer-testing-with-mock-integration">#</a></h2>
<p>Service layer tests verify business logic while controlling external dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_services.py - Service layer testing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> unittest.mock <span style="color:#f92672">import</span> AsyncMock, Mock
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.user_service <span style="color:#f92672">import</span> UserService
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.email_service <span style="color:#f92672">import</span> MockEmailService
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.services.analytics_service <span style="color:#f92672">import</span> MockAnalyticsService
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.models <span style="color:#f92672">import</span> User, UserCreate
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.exceptions <span style="color:#f92672">import</span> EmailAlreadyExistsError, SecurityError
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserService</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test user service business logic.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mock_user_repository</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create mock user repository.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> AsyncMock()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.fixture</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">email_service</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create mock email service that tracks calls.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> MockEmailService()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">analytics_service</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create mock analytics service that tracks calls.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> MockAnalyticsService()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.fixture</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">user_service</span>(self, mock_user_repository, email_service, analytics_service):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create user service with mocked dependencies.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> UserService(
</span></span><span style="display:flex;"><span>            user_repository<span style="color:#f92672">=</span>mock_user_repository,
</span></span><span style="display:flex;"><span>            email_service<span style="color:#f92672">=</span>email_service,
</span></span><span style="display:flex;"><span>            analytics_service<span style="color:#f92672">=</span>analytics_service
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_register_user_success</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        user_service, 
</span></span><span style="display:flex;"><span>        mock_user_repository, 
</span></span><span style="display:flex;"><span>        email_service, 
</span></span><span style="display:flex;"><span>        analytics_service,
</span></span><span style="display:flex;"><span>        test_session
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test successful user registration workflow.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;SecurePassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock repository responses</span>
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>  <span style="color:#75715e"># No existing user</span>
</span></span><span style="display:flex;"><span>        created_user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            hashed_password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$2b$12$hashedpassword&#34;</span>,
</span></span><span style="display:flex;"><span>            is_active<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            updated_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>create<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> created_user
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Execute</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>register_user(test_session, user_data, <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify result</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> result<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> result<span style="color:#f92672">.</span>full_name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Test User&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify repository interactions</span>
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>assert_called_once_with(
</span></span><span style="display:flex;"><span>            test_session, email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>create<span style="color:#f92672">.</span>assert_called_once()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify side effects</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(email_service<span style="color:#f92672">.</span>sent_emails) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        welcome_email <span style="color:#f92672">=</span> email_service<span style="color:#f92672">.</span>sent_emails[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> welcome_email[<span style="color:#e6db74">&#34;type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;welcome&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> welcome_email[<span style="color:#e6db74">&#34;to&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> welcome_email[<span style="color:#e6db74">&#34;user_name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Test User&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(analytics_service<span style="color:#f92672">.</span>tracked_events) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        registration_event <span style="color:#f92672">=</span> analytics_service<span style="color:#f92672">.</span>tracked_events[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> registration_event[<span style="color:#e6db74">&#34;event_type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;user_registration&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> registration_event[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> registration_event[<span style="color:#e6db74">&#34;user_email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_register_user_duplicate_email</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        user_service, 
</span></span><span style="display:flex;"><span>        mock_user_repository,
</span></span><span style="display:flex;"><span>        test_session
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test registration with existing email.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;existing@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;New User&#34;</span>,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock existing user</span>
</span></span><span style="display:flex;"><span>        existing_user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span><span style="color:#ae81ff">999</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;existing@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Existing User&#34;</span>,
</span></span><span style="display:flex;"><span>            hashed_password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$2b$12$existinghash&#34;</span>,
</span></span><span style="display:flex;"><span>            is_active<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            updated_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> existing_user
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Execute and verify exception</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(EmailAlreadyExistsError) <span style="color:#66d9ef">as</span> exc_info:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>register_user(test_session, user_data, <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify error details</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> exc_info<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;existing@example.com&#34;</span> <span style="color:#f92672">in</span> error<span style="color:#f92672">.</span>message
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;existing@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#34;attempted_registration_ip&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify no user creation attempted</span>
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>create<span style="color:#f92672">.</span>assert_not_called()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_register_user_email_failure_continues</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        user_service,
</span></span><span style="display:flex;"><span>        mock_user_repository,
</span></span><span style="display:flex;"><span>        email_service,
</span></span><span style="display:flex;"><span>        analytics_service,
</span></span><span style="display:flex;"><span>        test_session
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that email failures don&#39;t prevent user registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> UserCreate(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>, 
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock successful user creation</span>
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        created_user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            hashed_password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$2b$12$hash&#34;</span>,
</span></span><span style="display:flex;"><span>            is_active<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            updated_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>create<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> created_user
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make email service fail</span>
</span></span><span style="display:flex;"><span>        email_service<span style="color:#f92672">.</span>send_welcome_email <span style="color:#f92672">=</span> AsyncMock(side_effect<span style="color:#f92672">=</span><span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;SMTP Error&#34;</span>))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Execute - should not raise exception</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>register_user(test_session, user_data, <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify registration succeeded despite email failure</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> result<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify email was attempted</span>
</span></span><span style="display:flex;"><span>        email_service<span style="color:#f92672">.</span>send_welcome_email<span style="color:#f92672">.</span>assert_called_once_with(created_user)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify analytics still worked</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(analytics_service<span style="color:#f92672">.</span>tracked_events) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_authenticate_user_success</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        user_service,
</span></span><span style="display:flex;"><span>        mock_user_repository,
</span></span><span style="display:flex;"><span>        test_session
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test successful user authentication.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup</span>
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auth@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock user with correct password hash</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">from</span> neodyme.core.security <span style="color:#f92672">import</span> password_manager
</span></span><span style="display:flex;"><span>        hashed_password <span style="color:#f92672">=</span> password_manager<span style="color:#f92672">.</span>hash_password(password)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>email,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Auth User&#34;</span>,
</span></span><span style="display:flex;"><span>            hashed_password<span style="color:#f92672">=</span>hashed_password,
</span></span><span style="display:flex;"><span>            is_active<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            updated_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> user
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock request for rate limiting</span>
</span></span><span style="display:flex;"><span>        mock_request <span style="color:#f92672">=</span> Mock()
</span></span><span style="display:flex;"><span>        mock_request<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Execute</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>authenticate_user(test_session, email, password, mock_request)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify result</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;access_token&#34;</span> <span style="color:#f92672">in</span> result
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;refresh_token&#34;</span> <span style="color:#f92672">in</span> result
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> result[<span style="color:#e6db74">&#34;user&#34;</span>]<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> email
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify repository interactions</span>
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>assert_called_once_with(test_session, email<span style="color:#f92672">=</span>email)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_authenticate_user_wrong_password</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        user_service,
</span></span><span style="display:flex;"><span>        mock_user_repository,
</span></span><span style="display:flex;"><span>        test_session
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test authentication with wrong password.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Setup</span>
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wrong@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        correct_password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CorrectPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        wrong_password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;WrongPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock user with correct password hash</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">from</span> neodyme.core.security <span style="color:#f92672">import</span> password_manager
</span></span><span style="display:flex;"><span>        hashed_password <span style="color:#f92672">=</span> password_manager<span style="color:#f92672">.</span>hash_password(correct_password)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> User(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>email,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;User&#34;</span>,
</span></span><span style="display:flex;"><span>            hashed_password<span style="color:#f92672">=</span>hashed_password,
</span></span><span style="display:flex;"><span>            is_active<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            updated_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mock_user_repository<span style="color:#f92672">.</span>get_by_email<span style="color:#f92672">.</span>return_value <span style="color:#f92672">=</span> user
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Mock request</span>
</span></span><span style="display:flex;"><span>        mock_request <span style="color:#f92672">=</span> Mock()
</span></span><span style="display:flex;"><span>        mock_request<span style="color:#f92672">.</span>client<span style="color:#f92672">.</span>host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.1&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Execute and verify exception</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> pytest<span style="color:#f92672">.</span>raises(SecurityError) <span style="color:#66d9ef">as</span> exc_info:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>authenticate_user(test_session, email, wrong_password, mock_request)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify error details</span>
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> exc_info<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>error_code<span style="color:#f92672">.</span>value <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;INVALID_CREDENTIALS&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;Invalid email or password&#34;</span> <span style="color:#f92672">in</span> error<span style="color:#f92672">.</span>user_message
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error<span style="color:#f92672">.</span>context[<span style="color:#e6db74">&#34;reason&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;invalid_password&#34;</span></span></span></code></pre></div><p><strong>Why service layer testing with controlled mocks is effective:</strong></p>
<ul>
<li><strong>Business logic focus</strong> - Tests verify that business rules are correctly implemented without external dependencies</li>
<li><strong>Side effect verification</strong> - Tests can verify that appropriate side effects (emails, analytics) are triggered</li>
<li><strong>Error handling validation</strong> - Tests can verify error handling paths without reproducing complex error conditions</li>
<li><strong>Performance predictability</strong> - Tests run quickly because external services are mocked</li>
<li><strong>Behavior documentation</strong> - Tests serve as documentation of expected service behavior</li>
</ul>
<h2 id="api-integration-testing">API Integration Testing<a class="anchor" href="#api-integration-testing">#</a></h2>
<p>Integration tests verify that the complete API workflow functions correctly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_api_integration.py - Full API testing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> httpx <span style="color:#f92672">import</span> AsyncClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserAPIIntegration</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test complete user API workflows.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_registration_complete_workflow</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test complete user registration from API to database.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;integration@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Integration User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;SecurePassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Register user</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify response</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;access_token&#34;</span> <span style="color:#f92672">in</span> data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;refresh_token&#34;</span> <span style="color:#f92672">in</span> data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> data[<span style="color:#e6db74">&#34;token_type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;bearer&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;integration@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;full_name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Integration User&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#f92672">in</span> data[<span style="color:#e6db74">&#34;user&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify JWT token structure</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> jwt
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> jwt<span style="color:#f92672">.</span>decode(
</span></span><span style="display:flex;"><span>            data[<span style="color:#e6db74">&#34;access_token&#34;</span>], 
</span></span><span style="display:flex;"><span>            options<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;verify_signature&#34;</span>: <span style="color:#66d9ef">False</span>}
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> payload[<span style="color:#e6db74">&#34;sub&#34;</span>] <span style="color:#f92672">==</span> str(data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;id&#34;</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> payload[<span style="color:#e6db74">&#34;type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;access&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;permissions&#34;</span> <span style="color:#f92672">in</span> payload
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify side effects</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(test_client<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>sent_emails) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        email <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>sent_emails[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> email[<span style="color:#e6db74">&#34;type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;welcome&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> email[<span style="color:#e6db74">&#34;to&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;integration@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(test_client<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>tracked_events) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        event <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>tracked_events[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> event[<span style="color:#e6db74">&#34;event_type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;user_registration&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_login_workflow</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test user login after registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First register a user</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;login@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Login User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;LoginPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> register_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clear tracked side effects</span>
</span></span><span style="display:flex;"><span>        test_client<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>sent_emails<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>        test_client<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>tracked_events<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Now login</span>
</span></span><span style="display:flex;"><span>        login_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;login@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;LoginPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        login_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/login&#34;</span>, json<span style="color:#f92672">=</span>login_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify login response</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> login_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        login_data <span style="color:#f92672">=</span> login_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;access_token&#34;</span> <span style="color:#f92672">in</span> login_data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;refresh_token&#34;</span> <span style="color:#f92672">in</span> login_data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> login_data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;login@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify login analytics tracking</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(test_client<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>tracked_events) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        event <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>tracked_events[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> event[<span style="color:#e6db74">&#34;event_type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;user_login&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_protected_endpoint_access</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test accessing protected endpoints with authentication.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Register and get token</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;protected@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Protected User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;ProtectedPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        token_data <span style="color:#f92672">=</span> register_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        access_token <span style="color:#f92672">=</span> token_data[<span style="color:#e6db74">&#34;access_token&#34;</span>]
</span></span><span style="display:flex;"><span>        user_id <span style="color:#f92672">=</span> token_data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Access user profile with token</span>
</span></span><span style="display:flex;"><span>        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bearer </span><span style="color:#e6db74">{</span>access_token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>        profile_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> profile_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        profile_data <span style="color:#f92672">=</span> profile_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> profile_data[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;protected@example.com&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> profile_data[<span style="color:#e6db74">&#34;id&#34;</span>] <span style="color:#f92672">==</span> user_id
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Access specific user endpoint</span>
</span></span><span style="display:flex;"><span>        user_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/api/v1/users/</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> user_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> user_data[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;protected@example.com&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_unauthorized_access_blocked</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that protected endpoints block unauthorized access.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try to access protected endpoint without token</span>
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try with invalid token</span>
</span></span><span style="display:flex;"><span>        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">&#34;Bearer invalid-token&#34;</span>}
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">401</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try to access another user&#39;s data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First create a user and get token</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;user1@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;User One&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        user1_data <span style="color:#f92672">=</span> register_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        user1_token <span style="color:#f92672">=</span> user1_data[<span style="color:#e6db74">&#34;access_token&#34;</span>]
</span></span><span style="display:flex;"><span>        user1_id <span style="color:#f92672">=</span> user1_data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create second user</span>
</span></span><span style="display:flex;"><span>        user2_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;user2@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;User Two&#34;</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        register_response2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user2_data)
</span></span><span style="display:flex;"><span>        user2_data <span style="color:#f92672">=</span> register_response2<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        user2_id <span style="color:#f92672">=</span> user2_data[<span style="color:#e6db74">&#34;user&#34;</span>][<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try to access user2&#39;s data with user1&#39;s token</span>
</span></span><span style="display:flex;"><span>        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bearer </span><span style="color:#e6db74">{</span>user1_token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/api/v1/users/</span><span style="color:#e6db74">{</span>user2_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">403</span>  <span style="color:#75715e"># Forbidden</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_duplicate_registration_error</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that duplicate email registration is properly handled.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;duplicate@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;First User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;Password123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># First registration should succeed</span>
</span></span><span style="display:flex;"><span>        response1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response1<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Second registration with same email should fail</span>
</span></span><span style="display:flex;"><span>        duplicate_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;duplicate@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Second User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;DifferentPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        response2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>duplicate_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> response2<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">409</span>  <span style="color:#75715e"># Conflict</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        error_data <span style="color:#f92672">=</span> response2<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> error_data[<span style="color:#e6db74">&#34;error&#34;</span>][<span style="color:#e6db74">&#34;code&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;EMAIL_ALREADY_EXISTS&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;already exists&#34;</span> <span style="color:#f92672">in</span> error_data[<span style="color:#e6db74">&#34;error&#34;</span>][<span style="color:#e6db74">&#34;message&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_token_refresh_workflow</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test JWT token refresh functionality.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Register user and get tokens</span>
</span></span><span style="display:flex;"><span>        user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;refresh@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Refresh User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;RefreshPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        token_data <span style="color:#f92672">=</span> register_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        refresh_token <span style="color:#f92672">=</span> token_data[<span style="color:#e6db74">&#34;refresh_token&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use refresh token to get new access token</span>
</span></span><span style="display:flex;"><span>        refresh_data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;refresh_token&#34;</span>: refresh_token}
</span></span><span style="display:flex;"><span>        refresh_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/refresh&#34;</span>, json<span style="color:#f92672">=</span>refresh_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> refresh_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        new_token_data <span style="color:#f92672">=</span> refresh_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;access_token&#34;</span> <span style="color:#f92672">in</span> new_token_data
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> new_token_data[<span style="color:#e6db74">&#34;token_type&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;bearer&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify new token works</span>
</span></span><span style="display:flex;"><span>        headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bearer </span><span style="color:#e6db74">{</span>new_token_data[<span style="color:#e6db74">&#39;access_token&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>        profile_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> profile_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_password_validation_errors</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test password validation in registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        weak_passwords <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;123&#34;</span>,  <span style="color:#75715e"># Too short</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>,  <span style="color:#75715e"># No uppercase, no numbers, no special chars</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;PASSWORD&#34;</span>,  <span style="color:#75715e"># No lowercase, no numbers, no special chars</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Password&#34;</span>,  <span style="color:#75715e"># No numbers, no special chars</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Password123&#34;</span>,  <span style="color:#75715e"># No special chars</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> weak_password <span style="color:#f92672">in</span> weak_passwords:
</span></span><span style="display:flex;"><span>            user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;weak</span><span style="color:#e6db74">{</span>weak_password<span style="color:#e6db74">}</span><span style="color:#e6db74">@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Weak Password User&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: weak_password
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            error_data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> error_data[<span style="color:#e6db74">&#34;error&#34;</span>][<span style="color:#e6db74">&#34;code&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;WEAK_PASSWORD&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;requirements not met&#34;</span> <span style="color:#f92672">in</span> error_data[<span style="color:#e6db74">&#34;error&#34;</span>][<span style="color:#e6db74">&#34;message&#34;</span>]</span></span></code></pre></div><p><strong>Why comprehensive integration testing is crucial:</strong></p>
<ul>
<li><strong>End-to-end validation</strong> - Tests verify that the complete workflow from HTTP request to database storage works correctly</li>
<li><strong>Authentication flow testing</strong> - Tests verify that JWT tokens are generated, validated, and refreshed correctly</li>
<li><strong>Authorization verification</strong> - Tests ensure that access controls work correctly across different user scenarios</li>
<li><strong>Error handling validation</strong> - Tests verify that errors are handled correctly and return appropriate HTTP status codes</li>
<li><strong>Side effect confirmation</strong> - Tests verify that side effects like email sending and analytics tracking occur as expected</li>
</ul>
<h2 id="performance-and-load-testing">Performance and Load Testing<a class="anchor" href="#performance-and-load-testing">#</a></h2>
<p>Tests should also verify that the application performs adequately under load:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_performance.py - Performance testing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> httpx <span style="color:#f92672">import</span> AsyncClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestPerformance</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test application performance characteristics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_concurrent_user_registration</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test handling concurrent user registrations.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_user</span>(index: int):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Register a single user.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;concurrent</span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Concurrent User </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;ConcurrentPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>            end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;status_code&#34;</span>: response<span style="color:#f92672">.</span>status_code,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;duration&#34;</span>: end_time <span style="color:#f92672">-</span> start_time,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;user_id&#34;</span>: response<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;user&#34;</span>, {})<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;id&#34;</span>) <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Register 50 users concurrently</span>
</span></span><span style="display:flex;"><span>        tasks <span style="color:#f92672">=</span> [register_user(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50</span>)]
</span></span><span style="display:flex;"><span>        results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify all registrations succeeded</span>
</span></span><span style="display:flex;"><span>        successful_registrations <span style="color:#f92672">=</span> [r <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results <span style="color:#66d9ef">if</span> r[<span style="color:#e6db74">&#34;status_code&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(successful_registrations) <span style="color:#f92672">==</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify reasonable performance (adjust threshold based on your requirements)</span>
</span></span><span style="display:flex;"><span>        average_duration <span style="color:#f92672">=</span> sum(r[<span style="color:#e6db74">&#34;duration&#34;</span>] <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results) <span style="color:#f92672">/</span> len(results)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> average_duration <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1.0</span>  <span style="color:#75715e"># Should complete within 1 second on average</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify no duplicate user IDs</span>
</span></span><span style="display:flex;"><span>        user_ids <span style="color:#f92672">=</span> [r[<span style="color:#e6db74">&#34;user_id&#34;</span>] <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> successful_registrations]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> len(set(user_ids)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">50</span>  <span style="color:#75715e"># All unique</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_database_connection_pool_usage</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that database connection pooling works under load.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_authenticated_request</span>(index: int):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Create user and make authenticated request.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Register user</span>
</span></span><span style="display:flex;"><span>            user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;pool</span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Pool User </span><span style="color:#e6db74">{</span>index<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;PoolPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> register_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Make authenticated request</span>
</span></span><span style="display:flex;"><span>            token <span style="color:#f92672">=</span> register_response<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;access_token&#34;</span>]
</span></span><span style="display:flex;"><span>            headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bearer </span><span style="color:#e6db74">{</span>token<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            profile_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> profile_response<span style="color:#f92672">.</span>status_code
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make 100 concurrent requests</span>
</span></span><span style="display:flex;"><span>        tasks <span style="color:#f92672">=</span> [make_authenticated_request(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>)]
</span></span><span style="display:flex;"><span>        results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># All requests should succeed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> all(status <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span> <span style="color:#66d9ef">for</span> status <span style="color:#f92672">in</span> results)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_response_time_consistency</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test that response times are consistent.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        durations <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">20</span>):
</span></span><span style="display:flex;"><span>            user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;timing</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Timing User </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;TimingPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>            end_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>            durations<span style="color:#f92672">.</span>append(end_time <span style="color:#f92672">-</span> start_time)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate statistics</span>
</span></span><span style="display:flex;"><span>        average_duration <span style="color:#f92672">=</span> sum(durations) <span style="color:#f92672">/</span> len(durations)
</span></span><span style="display:flex;"><span>        max_duration <span style="color:#f92672">=</span> max(durations)
</span></span><span style="display:flex;"><span>        min_duration <span style="color:#f92672">=</span> min(durations)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify reasonable performance characteristics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> average_duration <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0.5</span>  <span style="color:#75715e"># Average under 500ms</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> max_duration <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1.0</span>  <span style="color:#75715e"># No request over 1 second</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify consistency (max shouldn&#39;t be more than 3x average)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> max_duration <span style="color:#f92672">&lt;</span> average_duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@pytest.mark.skip</span>(<span style="color:#e6db74">&#34;Only run for stress testing&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_memory_usage_under_load</span>(self, test_client: AsyncClient):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Test memory usage during high load (skip by default).&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> psutil
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        process <span style="color:#f92672">=</span> psutil<span style="color:#f92672">.</span>Process(os<span style="color:#f92672">.</span>getpid())
</span></span><span style="display:flex;"><span>        initial_memory <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>memory_info()<span style="color:#f92672">.</span>rss <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>  <span style="color:#75715e"># MB</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create 1000 users</span>
</span></span><span style="display:flex;"><span>        tasks <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1000</span>):
</span></span><span style="display:flex;"><span>            user_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;memory</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Memory User </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;MemoryPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            task <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>            tasks<span style="color:#f92672">.</span>append(task)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        results <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>tasks)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify all succeeded</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> all(r<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span> <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> results)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check memory usage</span>
</span></span><span style="display:flex;"><span>        final_memory <span style="color:#f92672">=</span> process<span style="color:#f92672">.</span>memory_info()<span style="color:#f92672">.</span>rss <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>  <span style="color:#75715e"># MB</span>
</span></span><span style="display:flex;"><span>        memory_increase <span style="color:#f92672">=</span> final_memory <span style="color:#f92672">-</span> initial_memory
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Memory increase should be reasonable (adjust threshold as needed)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> memory_increase <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>  <span style="color:#75715e"># Less than 100MB increase</span></span></span></code></pre></div><p><strong>Why performance testing in the test suite is valuable:</strong></p>
<ul>
<li><strong>Regression detection</strong> - Performance tests catch performance regressions during development</li>
<li><strong>Concurrency validation</strong> - Tests verify that the application handles concurrent requests correctly</li>
<li><strong>Resource usage monitoring</strong> - Tests ensure that the application doesn&rsquo;t have memory leaks or excessive resource usage</li>
<li><strong>SLA validation</strong> - Tests verify that the application meets performance requirements before deployment</li>
</ul>
<h2 id="test-organization-and-best-practices">Test Organization and Best Practices<a class="anchor" href="#test-organization-and-best-practices">#</a></h2>
<p>Organize tests for maintainability and clarity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># tests/test_organization_example.py - Test organization patterns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytest
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestUserWorkflows</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Organize tests by user workflows rather than technical layers.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestRegistrationWorkflow</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;All tests related to user registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_successful_registration</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test the happy path of user registration.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_registration_with_weak_password</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test registration validation with weak passwords.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_registration_with_duplicate_email</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test registration with existing email address.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_registration_side_effects</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test that registration triggers appropriate side effects.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestLoginWorkflow</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;All tests related to user login.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_successful_login</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test successful login with correct credentials.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_login_with_wrong_password</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test login with incorrect password.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_login_with_inactive_account</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test login with deactivated account.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_login_rate_limiting</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test login rate limiting after failed attempts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestProfileManagement</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;All tests related to profile management.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_view_own_profile</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test viewing own user profile.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_update_profile_information</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test updating profile information.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_cannot_view_other_profiles</span>(self, test_client):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34;Test that users cannot view other users&#39; profiles.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Test data factories for consistent test data</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestDataFactory</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Factory for creating consistent test data.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">user_data</span>(email: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, <span style="color:#f92672">**</span>overrides) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create valid user data for testing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;email&#34;</span>: email <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;test@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;full_name&#34;</span>: <span style="color:#e6db74">&#34;Test User&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;SecureTestPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>update(overrides)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">weak_password_data</span>(email: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create user data with weak password for testing validation.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TestDataFactory<span style="color:#f92672">.</span>user_data(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>email,
</span></span><span style="display:flex;"><span>            password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;weak&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">admin_user_data</span>(email: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Create admin user data for testing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TestDataFactory<span style="color:#f92672">.</span>user_data(
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>email <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;admin@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>            full_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Admin User&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Custom assertions for common test patterns</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestAssertions</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Custom assertions for common test patterns.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assert_valid_jwt_token</span>(token: str) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Assert that a string is a valid JWT token and return payload.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> jwt
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Decode without verification to check structure</span>
</span></span><span style="display:flex;"><span>        payload <span style="color:#f92672">=</span> jwt<span style="color:#f92672">.</span>decode(token, options<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;verify_signature&#34;</span>: <span style="color:#66d9ef">False</span>})
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify required fields</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;sub&#34;</span> <span style="color:#f92672">in</span> payload, <span style="color:#e6db74">&#34;JWT token missing &#39;sub&#39; (subject) field&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;exp&#34;</span> <span style="color:#f92672">in</span> payload, <span style="color:#e6db74">&#34;JWT token missing &#39;exp&#39; (expiration) field&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;iat&#34;</span> <span style="color:#f92672">in</span> payload, <span style="color:#e6db74">&#34;JWT token missing &#39;iat&#39; (issued at) field&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;type&#34;</span> <span style="color:#f92672">in</span> payload, <span style="color:#e6db74">&#34;JWT token missing &#39;type&#39; field&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> payload
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assert_valid_user_response</span>(user_data: Dict[str, Any], expected_email: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Assert that user response data has correct structure.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        required_fields <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;email&#34;</span>, <span style="color:#e6db74">&#34;full_name&#34;</span>, <span style="color:#e6db74">&#34;is_active&#34;</span>, <span style="color:#e6db74">&#34;created_at&#34;</span>, <span style="color:#e6db74">&#34;updated_at&#34;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> field <span style="color:#f92672">in</span> required_fields:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> field <span style="color:#f92672">in</span> user_data, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;User response missing required field: </span><span style="color:#e6db74">{</span>field<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> expected_email:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> user_data[<span style="color:#e6db74">&#34;email&#34;</span>] <span style="color:#f92672">==</span> expected_email
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Verify sensitive data is not included</span>
</span></span><span style="display:flex;"><span>        sensitive_fields <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;password&#34;</span>, <span style="color:#e6db74">&#34;hashed_password&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> field <span style="color:#f92672">in</span> sensitive_fields:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> field <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> user_data, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;User response includes sensitive field: </span><span style="color:#e6db74">{</span>field<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assert_error_response</span>(response_data: Dict[str, Any], expected_code: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Assert that error response has correct structure.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;error&#34;</span> <span style="color:#f92672">in</span> response_data, <span style="color:#e6db74">&#34;Error response missing &#39;error&#39; field&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        error <span style="color:#f92672">=</span> response_data[<span style="color:#e6db74">&#34;error&#34;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;code&#34;</span> <span style="color:#f92672">in</span> error, <span style="color:#e6db74">&#34;Error missing &#39;code&#39; field&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">in</span> error, <span style="color:#e6db74">&#34;Error missing &#39;message&#39; field&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> expected_code:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">assert</span> error[<span style="color:#e6db74">&#34;code&#34;</span>] <span style="color:#f92672">==</span> expected_code, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Expected error code </span><span style="color:#e6db74">{</span>expected_code<span style="color:#e6db74">}</span><span style="color:#e6db74">, got </span><span style="color:#e6db74">{</span>error[<span style="color:#e6db74">&#39;code&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example usage of organized testing</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@pytest.mark.asyncio</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_complete_user_journey</span>(test_client):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Test a complete user journey from registration to profile management.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Registration</span>
</span></span><span style="display:flex;"><span>    user_data <span style="color:#f92672">=</span> TestDataFactory<span style="color:#f92672">.</span>user_data(<span style="color:#e6db74">&#34;journey@example.com&#34;</span>)
</span></span><span style="display:flex;"><span>    register_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/register&#34;</span>, json<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> register_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">201</span>
</span></span><span style="display:flex;"><span>    register_data <span style="color:#f92672">=</span> register_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Verify registration response</span>
</span></span><span style="display:flex;"><span>    TestAssertions<span style="color:#f92672">.</span>assert_valid_jwt_token(register_data[<span style="color:#e6db74">&#34;access_token&#34;</span>])
</span></span><span style="display:flex;"><span>    TestAssertions<span style="color:#f92672">.</span>assert_valid_user_response(register_data[<span style="color:#e6db74">&#34;user&#34;</span>], <span style="color:#e6db74">&#34;journey@example.com&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Login</span>
</span></span><span style="display:flex;"><span>    login_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;email&#34;</span>: <span style="color:#e6db74">&#34;journey@example.com&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;password&#34;</span>: <span style="color:#e6db74">&#34;SecureTestPassword123!&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    login_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/auth/login&#34;</span>, json<span style="color:#f92672">=</span>login_data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> login_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    login_response_data <span style="color:#f92672">=</span> login_response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>    TestAssertions<span style="color:#f92672">.</span>assert_valid_jwt_token(login_response_data[<span style="color:#e6db74">&#34;access_token&#34;</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Profile access</span>
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Authorization&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bearer </span><span style="color:#e6db74">{</span>login_response_data[<span style="color:#e6db74">&#39;access_token&#39;</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span>    profile_response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> test_client<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;/api/v1/auth/me&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> profile_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    TestAssertions<span style="color:#f92672">.</span>assert_valid_user_response(profile_response<span style="color:#f92672">.</span>json(), <span style="color:#e6db74">&#34;journey@example.com&#34;</span>)</span></span></code></pre></div><p><strong>Why organized testing improves development:</strong></p>
<ul>
<li><strong>Workflow-based organization</strong> - Tests organized by user workflows are easier to understand and maintain than tests organized by technical layers</li>
<li><strong>Consistent test data</strong> - Test data factories ensure consistent, valid test data across all tests</li>
<li><strong>Reusable assertions</strong> - Custom assertions reduce code duplication and make test failures more descriptive</li>
<li><strong>Clear test intent</strong> - Well-organized tests serve as documentation of expected application behavior</li>
</ul>
<h2 id="what-youve-learned">What You&rsquo;ve Learned<a class="anchor" href="#what-youve-learned">#</a></h2>
<p>By the end of this chapter, you understand:</p>
<p>✅ <strong>Why implementation-focused tests provide false confidence</strong> - and how behavior-focused tests catch real bugs<br>
✅ <strong>Database integration testing strategies</strong> - testing with real databases while maintaining test isolation and speed<br>
✅ <strong>Service layer testing with controlled dependencies</strong> - verifying business logic while managing external service interactions<br>
✅ <strong>API integration testing patterns</strong> - testing complete workflows from HTTP requests to database persistence<br>
✅ <strong>Performance testing within the test suite</strong> - catching performance regressions and verifying scalability<br>
✅ <strong>Test organization and maintainability</strong> - structuring tests for clarity, reusability, and documentation value</p>
<p>More importantly, you&rsquo;ve built a test suite that gives you confidence to make changes while catching bugs before they reach production.</p>
<h2 id="building-blocks-for-next-chapters">Building Blocks for Next Chapters<a class="anchor" href="#building-blocks-for-next-chapters">#</a></h2>
<p>This testing foundation gives us:</p>
<ul>
<li><strong>HTTP handling</strong> ← Chapter 1: FastAPI basics</li>
<li><strong>Data persistence</strong> ← Chapter 2: Database integration</li>
<li><strong>Input validation</strong> ← Chapter 3: Request/response validation</li>
<li><strong>Schema evolution</strong> ← Chapter 4: Database migrations</li>
<li><strong>Clean architecture</strong> ← Chapter 5: Service layer organization</li>
<li><strong>Error handling</strong> ← Chapter 6: Professional error management</li>
<li><strong>Security</strong> ← Chapter 7: Authentication and authorization</li>
<li><strong>Configuration</strong> ← Chapter 8: Environment-aware configuration</li>
<li><strong>Testing</strong> ← You are here</li>
<li><strong>Deployment</strong> ← Chapter 10: Production-ready deployment</li>
</ul>
<h2 id="exercises">Exercises<a class="anchor" href="#exercises">#</a></h2>
<ol>
<li><strong>Add property-based testing</strong> - Use Hypothesis to generate test data that explores edge cases automatically</li>
<li><strong>Create performance benchmarks</strong> - Build tests that track performance metrics over time</li>
<li><strong>Implement mutation testing</strong> - Use mutation testing to verify that your tests actually catch bugs</li>
<li><strong>Add contract testing</strong> - Create API contract tests that verify backwards compatibility</li>
<li><strong>Build test data generators</strong> - Create realistic test data generators for load testing</li>
</ol>
<h2 id="resources-for-deeper-learning">Resources for Deeper Learning<a class="anchor" href="#resources-for-deeper-learning">#</a></h2>
<h3 id="testing-fundamentals">Testing Fundamentals<a class="anchor" href="#testing-fundamentals">#</a></h3>
<ul>
<li><strong>Effective Testing</strong>: Core principles of valuable testing - <a href="https://martinfowler.com/articles/practical-test-pyramid.html">https://martinfowler.com/articles/practical-test-pyramid.html</a></li>
<li><strong>Testing Best Practices</strong>: Comprehensive testing strategies - <a href="https://testdriven.io/blog/modern-test-driven-development/">https://testdriven.io/blog/modern-test-driven-development/</a></li>
<li><strong>Test Doubles Guide</strong>: When and how to use mocks, stubs, and fakes - <a href="https://martinfowler.com/bliki/TestDouble.html">https://martinfowler.com/bliki/TestDouble.html</a></li>
</ul>
<h3 id="async-and-database-testing">Async and Database Testing<a class="anchor" href="#async-and-database-testing">#</a></h3>
<ul>
<li><strong>FastAPI Testing Guide</strong>: Official testing documentation - <a href="https://fastapi.tiangolo.com/tutorial/testing/">https://fastapi.tiangolo.com/tutorial/testing/</a></li>
<li><strong>SQLAlchemy Testing</strong>: Database testing patterns - <a href="https://docs.sqlalchemy.org/en/20/orm/session_transaction.html#joining-a-session-into-an-external-transaction-such-as-for-test-suites">https://docs.sqlalchemy.org/en/20/orm/session_transaction.html#joining-a-session-into-an-external-transaction-such-as-for-test-suites</a></li>
<li><strong>Testcontainers Python</strong>: Container-based testing - <a href="https://testcontainers-python.readthedocs.io/en/latest/">https://testcontainers-python.readthedocs.io/en/latest/</a></li>
</ul>
<h3 id="advanced-testing-techniques">Advanced Testing Techniques<a class="anchor" href="#advanced-testing-techniques">#</a></h3>
<ul>
<li><strong>Property-Based Testing</strong>: Using Hypothesis for better test coverage - <a href="https://hypothesis.readthedocs.io/en/latest/">https://hypothesis.readthedocs.io/en/latest/</a></li>
<li><strong>Performance Testing</strong>: Load testing strategies - <a href="https://locust.io/">https://locust.io/</a></li>
<li><strong>Mutation Testing</strong>: Verifying test quality - <a href="https://mutmut.readthedocs.io/en/latest/">https://mutmut.readthedocs.io/en/latest/</a></li>
</ul>
<h3 id="test-organization-and-maintenance">Test Organization and Maintenance<a class="anchor" href="#test-organization-and-maintenance">#</a></h3>
<ul>
<li><strong>Test Organization Patterns</strong>: Structuring test suites for maintainability - <a href="https://docs.pytest.org/en/latest/example/index.html">https://docs.pytest.org/en/latest/example/index.html</a></li>
<li><strong>Test Data Management</strong>: Managing test data effectively - <a href="https://blog.cleancoder.com/uncle-bob/2017/10/03/TestContravariance.html">https://blog.cleancoder.com/uncle-bob/2017/10/03/TestContravariance.html</a></li>
<li><strong>CI/CD Testing</strong>: Integrating tests into deployment pipelines - <a href="https://docs.github.com/en/actions/automating-builds-and-tests/about-continuous-integration">https://docs.github.com/en/actions/automating-builds-and-tests/about-continuous-integration</a></li>
</ul>
<h3 id="why-these-resources-matter">Why These Resources Matter<a class="anchor" href="#why-these-resources-matter">#</a></h3>
<ul>
<li><strong>Testing principles</strong>: Understanding what makes tests valuable helps you write tests that actually improve development speed</li>
<li><strong>Async testing</strong>: Modern Python applications require specialized testing techniques for async operations</li>
<li><strong>Database testing</strong>: Proper database testing catches integration bugs while maintaining test performance</li>
<li><strong>Advanced techniques</strong>: Property-based testing and mutation testing can dramatically improve test effectiveness</li>
</ul>
<p><strong>Pro Tip</strong>: Start with the test pyramid concept to understand different types of tests, then focus on database integration testing patterns that match your application architecture.</p>
<h2 id="next-production-ready-deployment">Next: Production-Ready Deployment<a class="anchor" href="#next-production-ready-deployment">#</a></h2>
<p>You have a test suite that gives you confidence in your code, but now you need to deploy it reliably. How do you containerize your application? How do you handle secrets in production? How do you ensure your application starts successfully and remains healthy?</p>
<p>In Chapter 10, we&rsquo;ll explore deployment strategies that get your application to production safely and reliably.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Preview of Chapter 10</span>
</span></span><span style="display:flex;"><span>FROM python:<span style="color:#ae81ff">3.11</span><span style="color:#f92672">-</span>slim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Security: Create non-root user</span>
</span></span><span style="display:flex;"><span>RUN groupadd <span style="color:#f92672">-</span>r appuser <span style="color:#f92672">&amp;&amp;</span> useradd <span style="color:#f92672">-</span>r <span style="color:#f92672">-</span>g appuser appuser
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install dependencies</span>
</span></span><span style="display:flex;"><span>COPY requirements<span style="color:#f92672">.</span>txt <span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>RUN pip install <span style="color:#f92672">--</span>no<span style="color:#f92672">-</span>cache<span style="color:#f92672">-</span>dir <span style="color:#f92672">-</span>r requirements<span style="color:#f92672">.</span>txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Copy application</span>
</span></span><span style="display:flex;"><span>COPY <span style="color:#f92672">.</span> <span style="color:#f92672">/</span>app
</span></span><span style="display:flex;"><span>WORKDIR <span style="color:#f92672">/</span>app
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Health check</span>
</span></span><span style="display:flex;"><span>HEALTHCHECK <span style="color:#f92672">--</span>interval<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>s <span style="color:#f92672">--</span>timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>s <span style="color:#f92672">--</span>start<span style="color:#f92672">-</span>period<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>s \
</span></span><span style="display:flex;"><span>    CMD python <span style="color:#f92672">-</span>c <span style="color:#e6db74">&#34;import requests; requests.get(&#39;http://localhost:8000/health&#39;)&#34;</span> <span style="color:#f92672">||</span> exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER appuser
</span></span><span style="display:flex;"><span>EXPOSE <span style="color:#ae81ff">8000</span>
</span></span><span style="display:flex;"><span>CMD [<span style="color:#e6db74">&#34;python&#34;</span>, <span style="color:#e6db74">&#34;-m&#34;</span>, <span style="color:#e6db74">&#34;uvicorn&#34;</span>, <span style="color:#e6db74">&#34;neodyme.main:app&#34;</span>, <span style="color:#e6db74">&#34;--host&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, <span style="color:#e6db74">&#34;--port&#34;</span>, <span style="color:#e6db74">&#34;8000&#34;</span>]</span></span></code></pre></div><p>We&rsquo;ll explore how to build deployment systems that work reliably across different environments while maintaining security and performance.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/neodyme/docs/chapter-8/" class="flex align-center">
        <img src="/neodyme/icons/backward.svg" class="book-icon" alt="Previous" title="Chapter 8" />
        <span>Chapter 8</span>
      </a>
    
    </span>
    <span>
    
      <a href="/neodyme/docs/chapter-10/" class="flex align-center">
        <span>Chapter 10</span>
        <img src="/neodyme/icons/forward.svg" class="book-icon" alt="Next" title="Chapter 10" />
      </a>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        
        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-tests-that-dont-test-anything-useful">The Problem: Tests That Don&rsquo;t Test Anything Useful</a></li>
    <li><a href="#why-fast-tests-vs-slow-tests-is-the-wrong-question">Why Fast Tests vs Slow Tests Is the Wrong Question</a></li>
    <li><a href="#the-professional-testing-solution-behavior-driven-confidence">The Professional Testing Solution: Behavior-Driven Confidence</a></li>
    <li><a href="#unit-testing-with-real-database-integration">Unit Testing with Real Database Integration</a></li>
    <li><a href="#service-layer-testing-with-mock-integration">Service Layer Testing with Mock Integration</a></li>
    <li><a href="#api-integration-testing">API Integration Testing</a></li>
    <li><a href="#performance-and-load-testing">Performance and Load Testing</a></li>
    <li><a href="#test-organization-and-best-practices">Test Organization and Best Practices</a></li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-for-next-chapters">Building Blocks for Next Chapters</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#testing-fundamentals">Testing Fundamentals</a></li>
        <li><a href="#async-and-database-testing">Async and Database Testing</a></li>
        <li><a href="#advanced-testing-techniques">Advanced Testing Techniques</a></li>
        <li><a href="#test-organization-and-maintenance">Test Organization and Maintenance</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#next-production-ready-deployment">Next: Production-Ready Deployment</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>


















