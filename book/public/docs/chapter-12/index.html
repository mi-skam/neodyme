<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Chapter 12: &ldquo;I Need to Scale Beyond One Machine Like a Pro&rdquo;#
Your neodyme application is a success. Clean architecture, comprehensive observability, robust error handling—everything is working perfectly. Then the good problem arrives: traffic is growing exponentially. What started as 100 users per day is now 10,000. Response times are climbing from 100ms to 2 seconds. Your single server is gasping under the load.
You try the obvious fix: upgrade to a bigger server. It helps for a week, then the problem returns. You upgrade again. And again. Until you realize that throwing more hardware at the problem isn&rsquo;t sustainable. You need to scale horizontally, not just vertically.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://mi-skam.github.io/neodyme/docs/chapter-12/">
  <meta property="og:site_name" content="Neodyme Documentation">
  <meta property="og:title" content="Chapter 12">
  <meta property="og:description" content="Chapter 12: “I Need to Scale Beyond One Machine Like a Pro”# Your neodyme application is a success. Clean architecture, comprehensive observability, robust error handling—everything is working perfectly. Then the good problem arrives: traffic is growing exponentially. What started as 100 users per day is now 10,000. Response times are climbing from 100ms to 2 seconds. Your single server is gasping under the load.
You try the obvious fix: upgrade to a bigger server. It helps for a week, then the problem returns. You upgrade again. And again. Until you realize that throwing more hardware at the problem isn’t sustainable. You need to scale horizontally, not just vertically.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Chapter 12 | Neodyme Documentation</title>
<link rel="icon" href="/neodyme/favicon.png" >
<link rel="manifest" href="/neodyme/manifest.json">
<link rel="canonical" href="https://mi-skam.github.io/neodyme/docs/chapter-12/">
<link rel="stylesheet" href="/neodyme/book.min.c098be6fdb8410d437a0799e694b206fa639685582089c583ae6ac07afec1ff8.css" integrity="sha256-wJi&#43;b9uEENQ3oHmeaUsgb6Y5aFWCCJxYOuasB6/sH/g=" crossorigin="anonymous">


  <script defer src="/neodyme/fuse.min.js"></script>
  <script defer src="/neodyme/en.search.min.04d5bcdbbecca89239ba280801e173492bd5eb5605da624b9b4f15f0fa6262f2.js" integrity="sha256-BNW8277MqJI5uigIAeFzSSvV61YF2mJLm08V8PpiYvI=" crossorigin="anonymous"></script>

  
</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/neodyme/"><span>Neodyme Documentation</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>














  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-1/" class="">
      Chapter 1</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-2/" class="">
      Chapter 2</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-3/" class="">
      Chapter 3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-4/" class="">
      Chapter 4</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-5/" class="">
      Chapter 5</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-6/" class="">
      Chapter 6</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-7/" class="">
      Chapter 7</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-8/" class="">
      Chapter 8</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-9/" class="">
      Chapter 9</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-10/" class="">
      Chapter 10</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-11/" class="">
      Chapter 11</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/neodyme/docs/chapter-12/" class="active">
      Chapter 12</a>
  

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/neodyme/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Chapter 12</h3>

  <label for="toc-control">
    
    <img src="/neodyme/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-success-that-kills-performance">The Problem: Success That Kills Performance</a></li>
    <li><a href="#why-just-buy-a-bigger-server-doesnt-work">Why &ldquo;Just Buy a Bigger Server&rdquo; Doesn&rsquo;t Work</a></li>
    <li><a href="#the-horizontal-scaling-solution-distributed-architecture">The Horizontal Scaling Solution: Distributed Architecture</a>
      <ul>
        <li><a href="#caching-eliminating-redundant-work">Caching: Eliminating Redundant Work</a></li>
        <li><a href="#cached-service-layer-implementation">Cached Service Layer Implementation</a></li>
        <li><a href="#background-job-processing-async-operations">Background Job Processing: Async Operations</a></li>
        <li><a href="#updated-service-layer-with-background-jobs">Updated Service Layer with Background Jobs</a></li>
        <li><a href="#database-connection-optimization">Database Connection Optimization</a></li>
        <li><a href="#load-balancing-and-multi-instance-deployment">Load Balancing and Multi-Instance Deployment</a></li>
        <li><a href="#updated-api-layer-with-scaling-features">Updated API Layer with Scaling Features</a></li>
      </ul>
    </li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-complete-system-architecture">Building Blocks: Complete System Architecture</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#scaling-patterns-and-architecture">Scaling Patterns and Architecture</a></li>
        <li><a href="#caching-strategies">Caching Strategies</a></li>
        <li><a href="#background-processing">Background Processing</a></li>
        <li><a href="#database-performance">Database Performance</a></li>
        <li><a href="#load-balancing-and-deployment">Load Balancing and Deployment</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#conclusion-from-tutorial-to-production">Conclusion: From Tutorial to Production</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="chapter-12-i-need-to-scale-beyond-one-machine-like-a-pro">Chapter 12: &ldquo;I Need to Scale Beyond One Machine Like a Pro&rdquo;<a class="anchor" href="#chapter-12-i-need-to-scale-beyond-one-machine-like-a-pro">#</a></h1>
<p>Your neodyme application is a success. Clean architecture, comprehensive observability, robust error handling—everything is working perfectly. Then the good problem arrives: traffic is growing exponentially. What started as 100 users per day is now 10,000. Response times are climbing from 100ms to 2 seconds. Your single server is gasping under the load.</p>
<p>You try the obvious fix: upgrade to a bigger server. It helps for a week, then the problem returns. You upgrade again. And again. Until you realize that <strong>throwing more hardware at the problem isn&rsquo;t sustainable</strong>. You need to scale horizontally, not just vertically.</p>
<p>This is the moment every successful application faces: <strong>when success threatens to destroy the very system that created it</strong>. The question isn&rsquo;t whether your application will need to scale—it&rsquo;s whether your architecture can handle growth without collapsing.</p>
<h2 id="the-problem-success-that-kills-performance">The Problem: Success That Kills Performance<a class="anchor" href="#the-problem-success-that-kills-performance">#</a></h2>
<p>Let me ask you: Have you ever seen an application work perfectly in development but crawl to a halt under real user load? If so, you&rsquo;ve experienced the pain of systems that don&rsquo;t scale.</p>
<p>Here&rsquo;s what happens when traffic grows beyond your architecture&rsquo;s capacity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># What works fine with 100 users per day</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@router.get</span>(<span style="color:#e6db74">&#34;/users/</span><span style="color:#e6db74">{user_id}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_user</span>(user_id: int, session: AsyncSession <span style="color:#f92672">=</span> Depends(get_session)):
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_repository<span style="color:#f92672">.</span>get(session, id<span style="color:#f92672">=</span>user_id)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> user:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> HTTPException(<span style="color:#ae81ff">404</span>, <span style="color:#e6db74">&#34;User not found&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get user&#39;s posts</span>
</span></span><span style="display:flex;"><span>    posts <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> post_repository<span style="color:#f92672">.</span>get_by_user(session, user_id<span style="color:#f92672">=</span>user_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get user&#39;s preferences</span>
</span></span><span style="display:flex;"><span>    preferences <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> preference_repository<span style="color:#f92672">.</span>get_by_user(session, user_id<span style="color:#f92672">=</span>user_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> UserDetailResponse(
</span></span><span style="display:flex;"><span>        user<span style="color:#f92672">=</span>user,
</span></span><span style="display:flex;"><span>        posts<span style="color:#f92672">=</span>posts,
</span></span><span style="display:flex;"><span>        preferences<span style="color:#f92672">=</span>preferences
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># What happens with 10,000 users per day</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 3 database queries per request (user, posts, preferences)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 30,000 database queries per day</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Database connection pool exhausted</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Query performance degrades with table size</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Each request waits for database availability</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Response times climb from 100ms to 5+ seconds</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Users abandon requests, creating more retry load</span></span></span></code></pre></div><p><strong>Why simple solutions fail under real load:</strong></p>
<ul>
<li><strong>Database connection exhaustion</strong> - Single database servers have limited connection pools; concurrent requests quickly exhaust available connections</li>
<li><strong>Synchronous processing bottlenecks</strong> - Blocking operations prevent servers from handling multiple requests efficiently</li>
<li><strong>Memory and CPU limitations</strong> - Single servers have finite resources that become saturated as user load increases</li>
<li><strong>Network bandwidth saturation</strong> - Data transfer limits prevent servers from serving responses quickly enough</li>
<li><strong>Cascade failure amplification</strong> - Slow responses cause client retries, exponentially multiplying the actual load on already-stressed systems</li>
<li><strong>Linear cost scaling</strong> - Vertical scaling (bigger servers) becomes exponentially more expensive while providing diminishing returns</li>
</ul>
<p>The fundamental problem is that <strong>traditional architectures assume unlimited resources</strong> and don&rsquo;t account for the realities of concurrent user behavior and finite system capacity.</p>
<h2 id="why-just-buy-a-bigger-server-doesnt-work">Why &ldquo;Just Buy a Bigger Server&rdquo; Doesn&rsquo;t Work<a class="anchor" href="#why-just-buy-a-bigger-server-doesnt-work">#</a></h2>
<p>The naive approach to performance problems looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Month 1: Small server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 2 CPU cores, 4GB RAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Handles 1,000 requests/day perfectly</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - $50/month</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Month 3: Traffic doubles</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Upgrade to 4 CPU cores, 8GB RAM  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Handles 2,000 requests/day</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - $150/month</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Month 6: Traffic doubles again</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Upgrade to 8 CPU cores, 16GB RAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Handles 4,000 requests/day</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - $400/month</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Month 9: Traffic doubles again  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Upgrade to 16 CPU cores, 32GB RAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Handles 8,000 requests/day</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - $1,200/month</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Month 12: Single point of failure</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - 32 CPU cores, 64GB RAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - Still can&#39;t handle peak traffic</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - $3,000/month</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># - If this server goes down, entire application is offline</span></span></span></code></pre></div><p><strong>This approach fails because:</strong></p>
<ul>
<li><strong>Exponential cost growth</strong> - Server costs increase exponentially while performance gains decrease logarithmically</li>
<li><strong>Single point of failure</strong> - One server outage takes down your entire application, no matter how powerful it is</li>
<li><strong>Resource utilization inefficiency</strong> - Powerful servers are often underutilized during low traffic periods, wasting money</li>
<li><strong>Scaling ceiling</strong> - Physical limits exist; eventually you can&rsquo;t buy a bigger server</li>
<li><strong>Geographic limitations</strong> - Single servers can&rsquo;t provide low latency to users worldwide</li>
<li><strong>Deployment risk amplification</strong> - Updates to a single powerful server create higher risk than updates to multiple smaller servers</li>
</ul>
<h2 id="the-horizontal-scaling-solution-distributed-architecture">The Horizontal Scaling Solution: Distributed Architecture<a class="anchor" href="#the-horizontal-scaling-solution-distributed-architecture">#</a></h2>
<p>Professional scaling distributes load across multiple systems, each optimized for specific tasks. Here&rsquo;s how neodyme implements horizontal scaling:</p>
<h3 id="caching-eliminating-redundant-work">Caching: Eliminating Redundant Work<a class="anchor" href="#caching-eliminating-redundant-work">#</a></h3>
<p>The fastest query is the one you never have to run. Caching stores frequently accessed data in memory for instant retrieval:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/cache.py - Multi-layer caching strategy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any, Dict, Optional, Union, Callable
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> redis.asyncio <span style="color:#66d9ef">as</span> redis
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CacheService</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Multi-layer caching with in-memory and Redis support.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, redis_url: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, default_ttl: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>redis_client <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> redis_url:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>redis_client <span style="color:#f92672">=</span> redis<span style="color:#f92672">.</span>from_url(redis_url)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In-memory cache (L1)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_cache: Dict[str, Dict[str, Any]] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_access_times: Dict[str, datetime] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_memory_items <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>default_ttl <span style="color:#f92672">=</span> default_ttl
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, key: str) <span style="color:#f92672">-&gt;</span> Optional[Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get value from cache with L1 (memory) -&gt; L2 (Redis) -&gt; None fallback.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try L1 cache first (fastest)</span>
</span></span><span style="display:flex;"><span>        memory_result <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_get_from_memory(key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> memory_result <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> memory_result
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try L2 cache (Redis)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>redis_client:
</span></span><span style="display:flex;"><span>            redis_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_get_from_redis(key)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> redis_result <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Store in L1 for next time</span>
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>_store_in_memory(key, redis_result)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> redis_result
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        key: str, 
</span></span><span style="display:flex;"><span>        value: Any, 
</span></span><span style="display:flex;"><span>        ttl: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        cache_level: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;both&#34;</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Store value in cache with configurable storage levels.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ttl <span style="color:#f92672">=</span> ttl <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>default_ttl
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in memory cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cache_level <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#34;memory&#34;</span>, <span style="color:#e6db74">&#34;both&#34;</span>):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_store_in_memory(key, value, ttl)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in Redis cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cache_level <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#34;redis&#34;</span>, <span style="color:#e6db74">&#34;both&#34;</span>) <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>redis_client:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_store_in_redis(key, value, ttl)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(self, key: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Remove value from all cache levels.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove from memory</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_cache<span style="color:#f92672">.</span>pop(key, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_access_times<span style="color:#f92672">.</span>pop(key, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove from Redis</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>redis_client:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>redis_client<span style="color:#f92672">.</span>delete(key)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_or_set</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        key: str, 
</span></span><span style="display:flex;"><span>        factory: Callable[[], Any],
</span></span><span style="display:flex;"><span>        ttl: Optional[int] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get value from cache or compute and store if missing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try to get from cache first</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get(key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Compute value using factory function</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> factory() <span style="color:#66d9ef">if</span> asyncio<span style="color:#f92672">.</span>iscoroutinefunction(factory) <span style="color:#66d9ef">else</span> factory()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in cache for next time</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>set(key, result, ttl)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_from_memory</span>(self, key: str) <span style="color:#f92672">-&gt;</span> Optional[Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get value from in-memory cache.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>memory_cache:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        cache_entry <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>memory_cache[key]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if expired</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> datetime<span style="color:#f92672">.</span>utcnow() <span style="color:#f92672">&gt;</span> cache_entry[<span style="color:#e6db74">&#34;expires_at&#34;</span>]:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>memory_cache[key]
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>memory_access_times<span style="color:#f92672">.</span>pop(key, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update access time for LRU</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_access_times[key] <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> cache_entry[<span style="color:#e6db74">&#34;value&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_store_in_memory</span>(self, key: str, value: Any, ttl: int <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Store value in in-memory cache with LRU eviction.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        ttl <span style="color:#f92672">=</span> ttl <span style="color:#f92672">or</span> self<span style="color:#f92672">.</span>default_ttl
</span></span><span style="display:flex;"><span>        expires_at <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow() <span style="color:#f92672">+</span> timedelta(seconds<span style="color:#f92672">=</span>ttl)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Evict old entries if cache is full</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>memory_cache) <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>max_memory_items:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_evict_lru_items()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_cache[key] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;value&#34;</span>: value,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;expires_at&#34;</span>: expires_at
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>memory_access_times[key] <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_evict_lru_items</span>(self) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Evict least recently used items to make space.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sort by access time and remove oldest 20%</span>
</span></span><span style="display:flex;"><span>        items_to_remove <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>memory_cache) <span style="color:#f92672">//</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        sorted_items <span style="color:#f92672">=</span> sorted(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>memory_access_times<span style="color:#f92672">.</span>items(),
</span></span><span style="display:flex;"><span>            key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> key, _ <span style="color:#f92672">in</span> sorted_items[:items_to_remove]:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>memory_cache<span style="color:#f92672">.</span>pop(key, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>memory_access_times<span style="color:#f92672">.</span>pop(key, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_get_from_redis</span>(self, key: str) <span style="color:#f92672">-&gt;</span> Optional[Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get value from Redis cache.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>redis_client<span style="color:#f92672">.</span>get(key)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> result:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> pickle<span style="color:#f92672">.</span>loads(result)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Don&#39;t fail if Redis is down</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Redis get failed for key </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_store_in_redis</span>(self, key: str, value: Any, ttl: int) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Store value in Redis cache.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            serialized <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>dumps(value)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>redis_client<span style="color:#f92672">.</span>setex(key, ttl, serialized)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Don&#39;t fail if Redis is down</span>
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Redis set failed for key </span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cache key builders</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_user_cache_key</span>(user_id: int) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Build cache key for user data.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_user_posts_cache_key</span>(user_id: int, page: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, limit: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Build cache key for user posts.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user_posts:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">:page:</span><span style="color:#e6db74">{</span>page<span style="color:#e6db74">}</span><span style="color:#e6db74">:limit:</span><span style="color:#e6db74">{</span>limit<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_user_preferences_cache_key</span>(user_id: int) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Build cache key for user preferences.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;user_preferences:</span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global cache instance</span>
</span></span><span style="display:flex;"><span>cache <span style="color:#f92672">=</span> CacheService(redis_url<span style="color:#f92672">=</span>settings<span style="color:#f92672">.</span>redis_url <span style="color:#66d9ef">if</span> hasattr(settings, <span style="color:#e6db74">&#39;redis_url&#39;</span>) <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>)</span></span></code></pre></div><p><strong>Why multi-layer caching dramatically improves performance:</strong></p>
<ul>
<li><strong>L1 memory cache</strong> - Sub-millisecond access times for frequently used data eliminate database queries entirely</li>
<li><strong>L2 Redis cache</strong> - Shared cache across multiple application instances prevents duplicate work across servers</li>
<li><strong>Cache-aside pattern</strong> - Applications remain functional even if cache systems fail, ensuring reliability</li>
<li><strong>TTL-based invalidation</strong> - Automatic expiration ensures data freshness without manual cache management</li>
<li><strong>LRU eviction</strong> - Memory cache automatically removes least-used items to prevent memory exhaustion</li>
</ul>
<h3 id="cached-service-layer-implementation">Cached Service Layer Implementation<a class="anchor" href="#cached-service-layer-implementation">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># services/cached_user_service.py - Service layer with intelligent caching</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.cache <span style="color:#f92672">import</span> cache, build_user_cache_key, build_user_posts_cache_key
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.logging <span style="color:#f92672">import</span> log_with_context
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> track_cache_operation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CachedUserService</span>(UserService):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;User service with intelligent caching for performance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_user_by_id</span>(self, session: AsyncSession, user_id: int) <span style="color:#f92672">-&gt;</span> UserPublic:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get user with caching to avoid database queries.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        cache_key <span style="color:#f92672">=</span> build_user_cache_key(user_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Try cache first</span>
</span></span><span style="display:flex;"><span>        cached_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>get(cache_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cached_user:
</span></span><span style="display:flex;"><span>            cache_duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            track_cache_operation(<span style="color:#e6db74">&#34;user&#34;</span>, <span style="color:#e6db74">&#34;hit&#34;</span>, cache_duration)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            log_with_context(
</span></span><span style="display:flex;"><span>                logger,
</span></span><span style="display:flex;"><span>                logging<span style="color:#f92672">.</span>DEBUG,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Cache hit for user&#34;</span>,
</span></span><span style="display:flex;"><span>                user_id<span style="color:#f92672">=</span>user_id,
</span></span><span style="display:flex;"><span>                cache_duration_ms<span style="color:#f92672">=</span>round(cache_duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> UserPublic<span style="color:#f92672">.</span>model_validate(cached_user)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cache miss - get from database</span>
</span></span><span style="display:flex;"><span>        cache_miss_duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        track_cache_operation(<span style="color:#e6db74">&#34;user&#34;</span>, <span style="color:#e6db74">&#34;miss&#34;</span>, cache_miss_duration)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>DEBUG,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Cache miss for user - querying database&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user_id
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get from database using parent service</span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> super()<span style="color:#f92672">.</span>get_user_by_id(session, user_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Store in cache for next time (cache for 1 hour)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>set(cache_key, user<span style="color:#f92672">.</span>model_dump(), ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">3600</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        total_duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>DEBUG,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;User loaded from database and cached&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user_id,
</span></span><span style="display:flex;"><span>            total_duration_ms<span style="color:#f92672">=</span>round(total_duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_user_posts</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession, 
</span></span><span style="display:flex;"><span>        user_id: int,
</span></span><span style="display:flex;"><span>        page: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        limit: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> List[PostPublic]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get user posts with pagination caching.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        cache_key <span style="color:#f92672">=</span> build_user_posts_cache_key(user_id, page, limit)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check cache first</span>
</span></span><span style="display:flex;"><span>        cached_posts <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>get(cache_key)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cached_posts:
</span></span><span style="display:flex;"><span>            track_cache_operation(<span style="color:#e6db74">&#34;user_posts&#34;</span>, <span style="color:#e6db74">&#34;hit&#34;</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> [PostPublic<span style="color:#f92672">.</span>model_validate(post) <span style="color:#66d9ef">for</span> post <span style="color:#f92672">in</span> cached_posts]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cache miss - query database</span>
</span></span><span style="display:flex;"><span>        track_cache_operation(<span style="color:#e6db74">&#34;user_posts&#34;</span>, <span style="color:#e6db74">&#34;miss&#34;</span>, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        posts <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> post_repository<span style="color:#f92672">.</span>get_by_user_paginated(
</span></span><span style="display:flex;"><span>            session, user_id<span style="color:#f92672">=</span>user_id, page<span style="color:#f92672">=</span>page, limit<span style="color:#f92672">=</span>limit
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cache posts for 30 minutes (posts change less frequently than user data)</span>
</span></span><span style="display:flex;"><span>        posts_data <span style="color:#f92672">=</span> [post<span style="color:#f92672">.</span>model_dump() <span style="color:#66d9ef">for</span> post <span style="color:#f92672">in</span> posts]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>set(cache_key, posts_data, ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">1800</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> posts
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_user</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession, 
</span></span><span style="display:flex;"><span>        user_id: int, 
</span></span><span style="display:flex;"><span>        update_data: UserUpdate
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> UserPublic:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Update user and invalidate related caches.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update user in database</span>
</span></span><span style="display:flex;"><span>        updated_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> super()<span style="color:#f92672">.</span>update_user(session, user_id, update_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Invalidate caches that might now be stale</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_invalidate_user_caches(user_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Pre-populate cache with fresh data</span>
</span></span><span style="display:flex;"><span>        cache_key <span style="color:#f92672">=</span> build_user_cache_key(user_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>set(cache_key, updated_user<span style="color:#f92672">.</span>model_dump(), ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">3600</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;User updated and caches invalidated&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user_id
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> updated_user
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_invalidate_user_caches</span>(self, user_id: int) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Invalidate all caches related to a user.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Invalidate user data cache</span>
</span></span><span style="display:flex;"><span>        user_cache_key <span style="color:#f92672">=</span> build_user_cache_key(user_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>delete(user_cache_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Invalidate user posts caches (multiple pages)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># In production, you might use pattern-based deletion</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> page <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">6</span>):  <span style="color:#75715e"># Clear first 5 pages</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> limit <span style="color:#f92672">in</span> [<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">50</span>]:  <span style="color:#75715e"># Common page sizes</span>
</span></span><span style="display:flex;"><span>                posts_cache_key <span style="color:#f92672">=</span> build_user_posts_cache_key(user_id, page, limit)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>delete(posts_cache_key)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Invalidate user preferences cache</span>
</span></span><span style="display:flex;"><span>        preferences_cache_key <span style="color:#f92672">=</span> build_user_preferences_cache_key(user_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> cache<span style="color:#f92672">.</span>delete(preferences_cache_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">track_cache_operation</span>(cache_type: str, result: str, duration: float) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Track cache operations for monitoring.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> metrics
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    metrics<span style="color:#f92672">.</span>increment(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;cache.operations&#34;</span>,
</span></span><span style="display:flex;"><span>        tags<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;type&#34;</span>: cache_type, <span style="color:#e6db74">&#34;result&#34;</span>: result}
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> duration <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        metrics<span style="color:#f92672">.</span>timing(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;cache.duration&#34;</span>,
</span></span><span style="display:flex;"><span>            duration,
</span></span><span style="display:flex;"><span>            tags<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;type&#34;</span>: cache_type, <span style="color:#e6db74">&#34;result&#34;</span>: result}
</span></span><span style="display:flex;"><span>        )</span></span></code></pre></div><p><strong>Why intelligent caching requires careful invalidation:</strong></p>
<ul>
<li><strong>Cache consistency</strong> - Stale data in cache can show users outdated information, causing confusion and errors</li>
<li><strong>Invalidation strategy</strong> - Related data must be invalidated together to maintain consistency across different views</li>
<li><strong>Write-through caching</strong> - Updating cache immediately after database updates ensures fresh data for subsequent reads</li>
<li><strong>Performance monitoring</strong> - Cache hit/miss ratios reveal whether caching strategy is effective</li>
</ul>
<h3 id="background-job-processing-async-operations">Background Job Processing: Async Operations<a class="anchor" href="#background-job-processing-async-operations">#</a></h3>
<p>Long-running operations should never block user requests. Background job processing enables immediate responses while work continues asynchronously:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/background_jobs.py - Async job processing system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> Enum
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any, Dict, Optional, Callable
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass, asdict
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.background_jobs&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JobStatus</span>(Enum):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Job execution status.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    PENDING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pending&#34;</span>
</span></span><span style="display:flex;"><span>    RUNNING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;running&#34;</span>
</span></span><span style="display:flex;"><span>    COMPLETED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;completed&#34;</span>
</span></span><span style="display:flex;"><span>    FAILED <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;failed&#34;</span>
</span></span><span style="display:flex;"><span>    RETRYING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;retrying&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Job</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Background job definition.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    id: str
</span></span><span style="display:flex;"><span>    job_type: str
</span></span><span style="display:flex;"><span>    payload: Dict[str, Any]
</span></span><span style="display:flex;"><span>    status: JobStatus
</span></span><span style="display:flex;"><span>    created_at: datetime
</span></span><span style="display:flex;"><span>    started_at: Optional[datetime] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    completed_at: Optional[datetime] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    error_message: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    retry_count: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    max_retries: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BackgroundJobProcessor</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;In-memory background job processing system.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>job_queue: asyncio<span style="color:#f92672">.</span>Queue <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>Queue()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>jobs: Dict[str, Job] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>job_handlers: Dict[str, Callable] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>workers_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>worker_tasks: List[asyncio<span style="color:#f92672">.</span>Task] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_handler</span>(self, job_type: str, handler: Callable):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register a handler function for a job type.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>job_handlers[job_type] <span style="color:#f92672">=</span> handler
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Registered handler for job type: </span><span style="color:#e6db74">{</span>job_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">queue_job</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        job_type: str, 
</span></span><span style="display:flex;"><span>        payload: Dict[str, Any],
</span></span><span style="display:flex;"><span>        max_retries: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Queue a background job for processing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        job_id <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4())
</span></span><span style="display:flex;"><span>        job <span style="color:#f92672">=</span> Job(
</span></span><span style="display:flex;"><span>            id<span style="color:#f92672">=</span>job_id,
</span></span><span style="display:flex;"><span>            job_type<span style="color:#f92672">=</span>job_type,
</span></span><span style="display:flex;"><span>            payload<span style="color:#f92672">=</span>payload,
</span></span><span style="display:flex;"><span>            status<span style="color:#f92672">=</span>JobStatus<span style="color:#f92672">.</span>PENDING,
</span></span><span style="display:flex;"><span>            created_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            max_retries<span style="color:#f92672">=</span>max_retries
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>jobs[job_id] <span style="color:#f92672">=</span> job
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>job_queue<span style="color:#f92672">.</span>put(job_id)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Queued job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> of type </span><span style="color:#e6db74">{</span>job_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> job_id
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_job_status</span>(self, job_id: str) <span style="color:#f92672">-&gt;</span> Optional[Job]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get current status of a job.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>jobs<span style="color:#f92672">.</span>get(job_id)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_workers</span>(self, num_workers: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Start background worker processes.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>workers_running:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>warning(<span style="color:#e6db74">&#34;Workers already running&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>workers_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(num_workers):
</span></span><span style="display:flex;"><span>            task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(self<span style="color:#f92672">.</span>_worker(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;worker-</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>worker_tasks<span style="color:#f92672">.</span>append(task)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Started </span><span style="color:#e6db74">{</span>num_workers<span style="color:#e6db74">}</span><span style="color:#e6db74"> background workers&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">stop_workers</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Stop all background workers gracefully.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>workers_running <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Cancel all worker tasks</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> task <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>worker_tasks:
</span></span><span style="display:flex;"><span>            task<span style="color:#f92672">.</span>cancel()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Wait for workers to finish current jobs</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>gather(<span style="color:#f92672">*</span>self<span style="color:#f92672">.</span>worker_tasks, return_exceptions<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>worker_tasks<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Stopped all background workers&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_worker</span>(self, worker_name: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Background worker that processes jobs from the queue.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Background worker </span><span style="color:#e6db74">{</span>worker_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> started&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> self<span style="color:#f92672">.</span>workers_running:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Wait for a job (with timeout to check if we should stop)</span>
</span></span><span style="display:flex;"><span>                job_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>wait_for(self<span style="color:#f92672">.</span>job_queue<span style="color:#f92672">.</span>get(), timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_process_job(job_id, worker_name)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>TimeoutError:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># No job available, continue loop</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> asyncio<span style="color:#f92672">.</span>CancelledError:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Worker </span><span style="color:#e6db74">{</span>worker_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> cancelled&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Worker </span><span style="color:#e6db74">{</span>worker_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> error: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Background worker </span><span style="color:#e6db74">{</span>worker_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> stopped&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_process_job</span>(self, job_id: str, worker_name: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Process a single job.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        job <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>jobs<span style="color:#f92672">.</span>get(job_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> job:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> not found&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check if we have a handler for this job type</span>
</span></span><span style="display:flex;"><span>        handler <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>job_handlers<span style="color:#f92672">.</span>get(job<span style="color:#f92672">.</span>job_type)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> handler:
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;No handler registered for job type: </span><span style="color:#e6db74">{</span>job<span style="color:#f92672">.</span>job_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            job<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> JobStatus<span style="color:#f92672">.</span>FAILED
</span></span><span style="display:flex;"><span>            job<span style="color:#f92672">.</span>error_message <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;No handler for job type: </span><span style="color:#e6db74">{</span>job<span style="color:#f92672">.</span>job_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Update job status</span>
</span></span><span style="display:flex;"><span>        job<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> JobStatus<span style="color:#f92672">.</span>RUNNING
</span></span><span style="display:flex;"><span>        job<span style="color:#f92672">.</span>started_at <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Worker </span><span style="color:#e6db74">{</span>worker_name<span style="color:#e6db74">}</span><span style="color:#e6db74"> processing job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">{</span>job<span style="color:#f92672">.</span>job_type<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Execute the job handler</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> asyncio<span style="color:#f92672">.</span>iscoroutinefunction(handler):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> handler(job<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                handler(job<span style="color:#f92672">.</span>payload)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Mark job as completed</span>
</span></span><span style="display:flex;"><span>            job<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> JobStatus<span style="color:#f92672">.</span>COMPLETED
</span></span><span style="display:flex;"><span>            job<span style="color:#f92672">.</span>completed_at <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Job failed - decide whether to retry</span>
</span></span><span style="display:flex;"><span>            job<span style="color:#f92672">.</span>retry_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> job<span style="color:#f92672">.</span>retry_count <span style="color:#f92672">&lt;=</span> job<span style="color:#f92672">.</span>max_retries:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Schedule retry</span>
</span></span><span style="display:flex;"><span>                job<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> JobStatus<span style="color:#f92672">.</span>RETRYING
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> job<span style="color:#f92672">.</span>retry_count)  <span style="color:#75715e"># Exponential backoff</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>job_queue<span style="color:#f92672">.</span>put(job_id)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>warning(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> failed (attempt </span><span style="color:#e6db74">{</span>job<span style="color:#f92672">.</span>retry_count<span style="color:#e6db74">}</span><span style="color:#e6db74">), retrying: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Max retries exceeded</span>
</span></span><span style="display:flex;"><span>                job<span style="color:#f92672">.</span>status <span style="color:#f92672">=</span> JobStatus<span style="color:#f92672">.</span>FAILED
</span></span><span style="display:flex;"><span>                job<span style="color:#f92672">.</span>error_message <span style="color:#f92672">=</span> str(e)
</span></span><span style="display:flex;"><span>                job<span style="color:#f92672">.</span>completed_at <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Job </span><span style="color:#e6db74">{</span>job_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> failed permanently after </span><span style="color:#e6db74">{</span>job<span style="color:#f92672">.</span>retry_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> attempts: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global job processor</span>
</span></span><span style="display:flex;"><span>job_processor <span style="color:#f92672">=</span> BackgroundJobProcessor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Job handler registration decorator</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">job_handler</span>(job_type: str):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Decorator to register job handlers.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorator</span>(func):
</span></span><span style="display:flex;"><span>        job_processor<span style="color:#f92672">.</span>register_handler(job_type, func)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> func
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decorator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Job handlers for common operations</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@job_handler</span>(<span style="color:#e6db74">&#34;send_welcome_email&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_welcome_email_job</span>(payload: Dict[str, Any]):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Background job to send welcome email.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.services.user_service <span style="color:#f92672">import</span> user_service
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.core.database <span style="color:#f92672">import</span> get_async_session
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> payload[<span style="color:#e6db74">&#34;user_id&#34;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> get_async_session() <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>get_user_by_id(session, user_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>email_service<span style="color:#f92672">.</span>send_welcome_email(user)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Welcome email sent to user </span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@job_handler</span>(<span style="color:#e6db74">&#34;process_user_analytics&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">process_user_analytics_job</span>(payload: Dict[str, Any]):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Background job to process user analytics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.services.user_service <span style="color:#f92672">import</span> user_service
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> payload[<span style="color:#e6db74">&#34;user_id&#34;</span>]
</span></span><span style="display:flex;"><span>    event_type <span style="color:#f92672">=</span> payload[<span style="color:#e6db74">&#34;event_type&#34;</span>]
</span></span><span style="display:flex;"><span>    event_data <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;event_data&#34;</span>, {})
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> user_service<span style="color:#f92672">.</span>analytics_service<span style="color:#f92672">.</span>track_user_event(
</span></span><span style="display:flex;"><span>        user_id, event_type, event_data
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Analytics processed for user </span><span style="color:#e6db74">{</span>user_id<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>event_type<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@job_handler</span>(<span style="color:#e6db74">&#34;cleanup_expired_sessions&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cleanup_expired_sessions_job</span>(payload: Dict[str, Any]):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Background job to clean up expired sessions.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.core.database <span style="color:#f92672">import</span> get_async_session
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.repositories <span style="color:#f92672">import</span> session_repository
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> get_async_session() <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        deleted_count <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session_repository<span style="color:#f92672">.</span>cleanup_expired_sessions(session)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Cleaned up </span><span style="color:#e6db74">{</span>deleted_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> expired sessions&#34;</span>)</span></span></code></pre></div><p><strong>Why background job processing is essential for performance:</strong></p>
<ul>
<li><strong>Immediate user responses</strong> - Long-running operations don&rsquo;t block HTTP requests, providing instant feedback to users</li>
<li><strong>Failure isolation</strong> - Background job failures don&rsquo;t affect user-facing operations, maintaining application stability</li>
<li><strong>Retry mechanisms</strong> - Failed operations can be retried automatically with exponential backoff, improving reliability</li>
<li><strong>Resource optimization</strong> - CPU-intensive operations can be processed during low-traffic periods, improving overall efficiency</li>
</ul>
<h3 id="updated-service-layer-with-background-jobs">Updated Service Layer with Background Jobs<a class="anchor" href="#updated-service-layer-with-background-jobs">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># services/async_user_service.py - Service layer with background processing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.background_jobs <span style="color:#f92672">import</span> job_processor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AsyncUserService</span>(CachedUserService):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;User service with background job processing for performance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_user</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession, 
</span></span><span style="display:flex;"><span>        user_data: UserCreate,
</span></span><span style="display:flex;"><span>        ip_address: str
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> UserPublic:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register user with immediate response and background processing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Core user creation (fast, synchronous)</span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_create_user_core(session, user_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Queue background jobs for side effects</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>_queue_registration_side_effects(user, ip_address)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Return immediately to user</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> UserPublic<span style="color:#f92672">.</span>model_validate(user)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_create_user_core</span>(self, session: AsyncSession, user_data: UserCreate) <span style="color:#f92672">-&gt;</span> User:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Core user creation logic - must be fast and reliable.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Check for existing user</span>
</span></span><span style="display:flex;"><span>        existing_user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>user_repository<span style="color:#f92672">.</span>get_by_email(session, email<span style="color:#f92672">=</span>user_data<span style="color:#f92672">.</span>email)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> existing_user:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> EmailAlreadyExistsError(user_data<span style="color:#f92672">.</span>email)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create user record</span>
</span></span><span style="display:flex;"><span>        user <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>user_repository<span style="color:#f92672">.</span>create(session, obj_in<span style="color:#f92672">=</span>user_data)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;User created successfully&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>            email<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>email
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> user
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_queue_registration_side_effects</span>(self, user: User, ip_address: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Queue background jobs for registration side effects.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Queue welcome email (non-critical, can retry)</span>
</span></span><span style="display:flex;"><span>        welcome_email_job_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>queue_job(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;send_welcome_email&#34;</span>,
</span></span><span style="display:flex;"><span>            {<span style="color:#e6db74">&#34;user_id&#34;</span>: user<span style="color:#f92672">.</span>id},
</span></span><span style="display:flex;"><span>            max_retries<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Queue analytics tracking (non-critical, can retry)</span>
</span></span><span style="display:flex;"><span>        analytics_job_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>queue_job(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;process_user_analytics&#34;</span>,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;user_id&#34;</span>: user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;event_type&#34;</span>: <span style="color:#e6db74">&#34;user_registration&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;event_data&#34;</span>: {<span style="color:#e6db74">&#34;ip_address&#34;</span>: ip_address}
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            max_retries<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Queue audit logging (more critical, more retries)</span>
</span></span><span style="display:flex;"><span>        audit_job_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>queue_job(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;log_user_audit&#34;</span>,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;user_id&#34;</span>: user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;action&#34;</span>: <span style="color:#e6db74">&#34;user_created&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ip_address&#34;</span>: ip_address
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            max_retries<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Registration side effects queued&#34;</span>,
</span></span><span style="display:flex;"><span>            user_id<span style="color:#f92672">=</span>user<span style="color:#f92672">.</span>id,
</span></span><span style="display:flex;"><span>            welcome_email_job<span style="color:#f92672">=</span>welcome_email_job_id,
</span></span><span style="display:flex;"><span>            analytics_job<span style="color:#f92672">=</span>analytics_job_id,
</span></span><span style="display:flex;"><span>            audit_job<span style="color:#f92672">=</span>audit_job_id
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">bulk_update_user_preferences</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        session: AsyncSession,
</span></span><span style="display:flex;"><span>        user_ids: List[int],
</span></span><span style="display:flex;"><span>        preference_updates: Dict[str, Any]
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> Dict[str, str]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Update preferences for multiple users using background processing.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Queue individual update jobs for each user</span>
</span></span><span style="display:flex;"><span>        job_ids <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> user_id <span style="color:#f92672">in</span> user_ids:
</span></span><span style="display:flex;"><span>            job_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>queue_job(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;update_user_preferences&#34;</span>,
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;user_id&#34;</span>: user_id,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;preference_updates&#34;</span>: preference_updates
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            job_ids[str(user_id)] <span style="color:#f92672">=</span> job_id
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        log_with_context(
</span></span><span style="display:flex;"><span>            logger,
</span></span><span style="display:flex;"><span>            logging<span style="color:#f92672">.</span>INFO,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Bulk preference updates queued&#34;</span>,
</span></span><span style="display:flex;"><span>            user_count<span style="color:#f92672">=</span>len(user_ids),
</span></span><span style="display:flex;"><span>            job_count<span style="color:#f92672">=</span>len(job_ids)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> job_ids
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_bulk_operation_status</span>(self, job_ids: List[str]) <span style="color:#f92672">-&gt;</span> Dict[str, Dict[str, Any]]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get status of multiple background jobs.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        status_results <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> job_id <span style="color:#f92672">in</span> job_ids:
</span></span><span style="display:flex;"><span>            job <span style="color:#f92672">=</span> job_processor<span style="color:#f92672">.</span>get_job_status(job_id)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> job:
</span></span><span style="display:flex;"><span>                status_results[job_id] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;status&#34;</span>: job<span style="color:#f92672">.</span>status<span style="color:#f92672">.</span>value,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;created_at&#34;</span>: job<span style="color:#f92672">.</span>created_at<span style="color:#f92672">.</span>isoformat(),
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;completed_at&#34;</span>: job<span style="color:#f92672">.</span>completed_at<span style="color:#f92672">.</span>isoformat() <span style="color:#66d9ef">if</span> job<span style="color:#f92672">.</span>completed_at <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;error_message&#34;</span>: job<span style="color:#f92672">.</span>error_message,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;retry_count&#34;</span>: job<span style="color:#f92672">.</span>retry_count
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                status_results[job_id] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;not_found&#34;</span>}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> status_results</span></span></code></pre></div><p><strong>Why async service patterns enable scalability:</strong></p>
<ul>
<li><strong>Parallel processing</strong> - Multiple background workers can process jobs concurrently, dramatically increasing throughput</li>
<li><strong>User experience optimization</strong> - Users get immediate responses while slow operations happen in the background</li>
<li><strong>Failure recovery</strong> - Background jobs can be retried without affecting user interactions</li>
<li><strong>Load distribution</strong> - Background processing can be scaled independently from web request handling</li>
</ul>
<h3 id="database-connection-optimization">Database Connection Optimization<a class="anchor" href="#database-connection-optimization">#</a></h3>
<p>Database connections are often the bottleneck in scaled applications. Proper connection management is crucial:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># core/database.py - Optimized database connection management</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> asynccontextmanager
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.asyncio <span style="color:#f92672">import</span> AsyncSession, async_sessionmaker, create_async_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.pool <span style="color:#f92672">import</span> QueuePool
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;neodyme.database&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DatabaseManager</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Optimized database connection management.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, database_url: str):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Connection pool optimization</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>engine <span style="color:#f92672">=</span> create_async_engine(
</span></span><span style="display:flex;"><span>            database_url,
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Connection pool settings for high concurrency</span>
</span></span><span style="display:flex;"><span>            poolclass<span style="color:#f92672">=</span>QueuePool,
</span></span><span style="display:flex;"><span>            pool_size<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,                    <span style="color:#75715e"># Base connections to maintain</span>
</span></span><span style="display:flex;"><span>            max_overflow<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>,                 <span style="color:#75715e"># Additional connections under load  </span>
</span></span><span style="display:flex;"><span>            pool_pre_ping<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,              <span style="color:#75715e"># Validate connections before use</span>
</span></span><span style="display:flex;"><span>            pool_recycle<span style="color:#f92672">=</span><span style="color:#ae81ff">3600</span>,               <span style="color:#75715e"># Refresh connections every hour</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Query optimization</span>
</span></span><span style="display:flex;"><span>            echo<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,                      <span style="color:#75715e"># Disable SQL logging in production</span>
</span></span><span style="display:flex;"><span>            future<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,                     <span style="color:#75715e"># Use SQLAlchemy 2.0 style</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Async optimization</span>
</span></span><span style="display:flex;"><span>            connect_args<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;command_timeout&#34;</span>: <span style="color:#ae81ff">60</span>,       <span style="color:#75715e"># Query timeout</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;server_settings&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;application_name&#34;</span>: <span style="color:#e6db74">&#34;neodyme_app&#34;</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;jit&#34;</span>: <span style="color:#e6db74">&#34;off&#34;</span>             <span style="color:#75715e"># Disable JIT for predictable performance</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>session_maker <span style="color:#f92672">=</span> async_sessionmaker(
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>engine,
</span></span><span style="display:flex;"><span>            class_<span style="color:#f92672">=</span>AsyncSession,
</span></span><span style="display:flex;"><span>            expire_on_commit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,          <span style="color:#75715e"># Keep objects accessible after commit</span>
</span></span><span style="display:flex;"><span>            autoflush<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,                  <span style="color:#75715e"># Auto-flush before queries</span>
</span></span><span style="display:flex;"><span>            autocommit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>                 <span style="color:#75715e"># Explicit transaction control</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Connection monitoring</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>peak_connections <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>connection_errors <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>(self) <span style="color:#f92672">-&gt;</span> AsyncSession:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get database session with connection monitoring.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>peak_connections <span style="color:#f92672">=</span> max(self<span style="color:#f92672">.</span>peak_connections, self<span style="color:#f92672">.</span>active_connections)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            session <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>session_maker()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>connection_errors <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Database connection failed: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Connection will be released when session is closed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@asynccontextmanager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session_context</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Context manager for automatic session cleanup.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        session <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get_session()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">yield</span> session
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>rollback()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">finally</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_connection_stats</span>(self) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get database connection statistics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get pool statistics</span>
</span></span><span style="display:flex;"><span>        pool <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>engine<span style="color:#f92672">.</span>pool
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;pool_size&#34;</span>: pool<span style="color:#f92672">.</span>size(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checked_in&#34;</span>: pool<span style="color:#f92672">.</span>checkedin(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;checked_out&#34;</span>: pool<span style="color:#f92672">.</span>checkedout(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;overflow&#34;</span>: pool<span style="color:#f92672">.</span>overflow(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;invalidated&#34;</span>: pool<span style="color:#f92672">.</span>invalidated(),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;active_connections&#34;</span>: self<span style="color:#f92672">.</span>active_connections,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;peak_connections&#34;</span>: self<span style="color:#f92672">.</span>peak_connections,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;connection_errors&#34;</span>: self<span style="color:#f92672">.</span>connection_errors
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">health_check</span>(self) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Check database health and performance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        start_time <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> self<span style="color:#f92672">.</span>get_session_context() <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Simple query to test connectivity</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;SELECT 1&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> result<span style="color:#f92672">.</span>fetchone()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;connection_stats&#34;</span>: <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get_connection_stats()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            duration <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time() <span style="color:#f92672">-</span> start_time
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;healthy&#34;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;error&#34;</span>: str(e),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;response_time_ms&#34;</span>: round(duration <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;connection_stats&#34;</span>: <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get_connection_stats()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global database manager</span>
</span></span><span style="display:flex;"><span>db_manager <span style="color:#f92672">=</span> DatabaseManager(settings<span style="color:#f92672">.</span>database_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Updated dependency for FastAPI</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_async_session</span>() <span style="color:#f92672">-&gt;</span> AsyncSession:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;FastAPI dependency for database sessions.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> db_manager<span style="color:#f92672">.</span>get_session_context() <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Connection monitoring for health checks</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_database_health</span>() <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Get database health information.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> db_manager<span style="color:#f92672">.</span>health_check()</span></span></code></pre></div><p><strong>Why optimized database connections prevent scaling bottlenecks:</strong></p>
<ul>
<li><strong>Connection pooling</strong> - Reusing database connections eliminates the overhead of creating new connections for each request</li>
<li><strong>Pool sizing optimization</strong> - Proper pool configuration balances resource usage with connection availability under load</li>
<li><strong>Connection validation</strong> - Pre-ping ensures that stale connections are detected and replaced before causing query failures</li>
<li><strong>Resource monitoring</strong> - Connection statistics help identify when database access patterns need optimization</li>
</ul>
<h3 id="load-balancing-and-multi-instance-deployment">Load Balancing and Multi-Instance Deployment<a class="anchor" href="#load-balancing-and-multi-instance-deployment">#</a></h3>
<p>Running multiple application instances distributes load and provides redundancy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># deployment/load_balancer.py - Application instance coordination</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, List, Any
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dataclasses <span style="color:#f92672">import</span> dataclass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@dataclass</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InstanceInfo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Information about a running application instance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    instance_id: str
</span></span><span style="display:flex;"><span>    host: str
</span></span><span style="display:flex;"><span>    port: int
</span></span><span style="display:flex;"><span>    started_at: datetime
</span></span><span style="display:flex;"><span>    last_heartbeat: datetime
</span></span><span style="display:flex;"><span>    active_connections: int
</span></span><span style="display:flex;"><span>    cpu_usage: float
</span></span><span style="display:flex;"><span>    memory_usage: float
</span></span><span style="display:flex;"><span>    healthy: bool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InstanceRegistry</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Registry for coordinating multiple application instances.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>instances: Dict[str, InstanceInfo] <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>heartbeat_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>  <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>instance_timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>   <span style="color:#75715e"># seconds</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">register_instance</span>(
</span></span><span style="display:flex;"><span>        self, 
</span></span><span style="display:flex;"><span>        instance_id: str,
</span></span><span style="display:flex;"><span>        host: str, 
</span></span><span style="display:flex;"><span>        port: int
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Register a new application instance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        instance <span style="color:#f92672">=</span> InstanceInfo(
</span></span><span style="display:flex;"><span>            instance_id<span style="color:#f92672">=</span>instance_id,
</span></span><span style="display:flex;"><span>            host<span style="color:#f92672">=</span>host,
</span></span><span style="display:flex;"><span>            port<span style="color:#f92672">=</span>port,
</span></span><span style="display:flex;"><span>            started_at<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            last_heartbeat<span style="color:#f92672">=</span>datetime<span style="color:#f92672">.</span>utcnow(),
</span></span><span style="display:flex;"><span>            active_connections<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            cpu_usage<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>            memory_usage<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>            healthy<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>instances[instance_id] <span style="color:#f92672">=</span> instance
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Registered instance </span><span style="color:#e6db74">{</span>instance_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> at </span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">update_instance_metrics</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        instance_id: str,
</span></span><span style="display:flex;"><span>        active_connections: int,
</span></span><span style="display:flex;"><span>        cpu_usage: float,
</span></span><span style="display:flex;"><span>        memory_usage: float
</span></span><span style="display:flex;"><span>    ) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Update metrics for an instance.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> instance_id <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>instances:
</span></span><span style="display:flex;"><span>            instance <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>instances[instance_id]
</span></span><span style="display:flex;"><span>            instance<span style="color:#f92672">.</span>last_heartbeat <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>            instance<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">=</span> active_connections
</span></span><span style="display:flex;"><span>            instance<span style="color:#f92672">.</span>cpu_usage <span style="color:#f92672">=</span> cpu_usage
</span></span><span style="display:flex;"><span>            instance<span style="color:#f92672">.</span>memory_usage <span style="color:#f92672">=</span> memory_usage
</span></span><span style="display:flex;"><span>            instance<span style="color:#f92672">.</span>healthy <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>  <span style="color:#75715e"># Receiving metrics means instance is healthy</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_healthy_instances</span>(self) <span style="color:#f92672">-&gt;</span> List[InstanceInfo]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get list of healthy, responsive instances.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>        healthy_instances <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> instance <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>instances<span style="color:#f92672">.</span>values():
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check if instance has sent heartbeat recently</span>
</span></span><span style="display:flex;"><span>            seconds_since_heartbeat <span style="color:#f92672">=</span> (now <span style="color:#f92672">-</span> instance<span style="color:#f92672">.</span>last_heartbeat)<span style="color:#f92672">.</span>total_seconds()
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> seconds_since_heartbeat <span style="color:#f92672">&lt;=</span> self<span style="color:#f92672">.</span>instance_timeout <span style="color:#f92672">and</span> instance<span style="color:#f92672">.</span>healthy:
</span></span><span style="display:flex;"><span>                healthy_instances<span style="color:#f92672">.</span>append(instance)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Mark as unhealthy</span>
</span></span><span style="display:flex;"><span>                instance<span style="color:#f92672">.</span>healthy <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>                logger<span style="color:#f92672">.</span>warning(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Instance </span><span style="color:#e6db74">{</span>instance<span style="color:#f92672">.</span>instance_id<span style="color:#e6db74">}</span><span style="color:#e6db74"> marked unhealthy &#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;(last heartbeat: </span><span style="color:#e6db74">{</span>seconds_since_heartbeat<span style="color:#e6db74">}</span><span style="color:#e6db74">s ago)&#34;</span>
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> healthy_instances
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_least_loaded_instance</span>(self) <span style="color:#f92672">-&gt;</span> InstanceInfo:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get the instance with the lowest load for new requests.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        healthy_instances <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get_healthy_instances()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> healthy_instances:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#34;No healthy instances available&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sort by load (combination of connections and CPU usage)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_score</span>(instance):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> instance<span style="color:#f92672">.</span>active_connections <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.7</span> <span style="color:#f92672">+</span> instance<span style="color:#f92672">.</span>cpu_usage <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> min(healthy_instances, key<span style="color:#f92672">=</span>load_score)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cluster_stats</span>(self) <span style="color:#f92672">-&gt;</span> Dict[str, Any]:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Get overall cluster statistics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        healthy_instances <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> self<span style="color:#f92672">.</span>get_healthy_instances()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> healthy_instances:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;total_instances&#34;</span>: len(self<span style="color:#f92672">.</span>instances),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;healthy_instances&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;total_connections&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;average_cpu_usage&#34;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;average_memory_usage&#34;</span>: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        total_connections <span style="color:#f92672">=</span> sum(i<span style="color:#f92672">.</span>active_connections <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> healthy_instances)
</span></span><span style="display:flex;"><span>        avg_cpu <span style="color:#f92672">=</span> sum(i<span style="color:#f92672">.</span>cpu_usage <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> healthy_instances) <span style="color:#f92672">/</span> len(healthy_instances)
</span></span><span style="display:flex;"><span>        avg_memory <span style="color:#f92672">=</span> sum(i<span style="color:#f92672">.</span>memory_usage <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> healthy_instances) <span style="color:#f92672">/</span> len(healthy_instances)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;total_instances&#34;</span>: len(self<span style="color:#f92672">.</span>instances),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;healthy_instances&#34;</span>: len(healthy_instances),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;total_connections&#34;</span>: total_connections,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;average_cpu_usage&#34;</span>: avg_cpu,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;average_memory_usage&#34;</span>: avg_memory,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;instances&#34;</span>: [
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;instance_id&#34;</span>: i<span style="color:#f92672">.</span>instance_id,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;host&#34;</span>: i<span style="color:#f92672">.</span>host,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;port&#34;</span>: i<span style="color:#f92672">.</span>port,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;active_connections&#34;</span>: i<span style="color:#f92672">.</span>active_connections,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;cpu_usage&#34;</span>: i<span style="color:#f92672">.</span>cpu_usage,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;memory_usage&#34;</span>: i<span style="color:#f92672">.</span>memory_usage,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;uptime_seconds&#34;</span>: (datetime<span style="color:#f92672">.</span>utcnow() <span style="color:#f92672">-</span> i<span style="color:#f92672">.</span>started_at)<span style="color:#f92672">.</span>total_seconds()
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> healthy_instances
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global instance registry</span>
</span></span><span style="display:flex;"><span>instance_registry <span style="color:#f92672">=</span> InstanceRegistry()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Instance health reporting</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">report_instance_metrics</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Report current instance metrics to the registry.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> psutil
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    instance_id <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;INSTANCE_ID&#34;</span>, <span style="color:#e6db74">&#34;default&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get system metrics</span>
</span></span><span style="display:flex;"><span>        cpu_usage <span style="color:#f92672">=</span> psutil<span style="color:#f92672">.</span>cpu_percent(interval<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        memory_usage <span style="color:#f92672">=</span> psutil<span style="color:#f92672">.</span>virtual_memory()<span style="color:#f92672">.</span>percent
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get application-specific metrics</span>
</span></span><span style="display:flex;"><span>        active_connections <span style="color:#f92672">=</span> db_manager<span style="color:#f92672">.</span>active_connections
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> instance_registry<span style="color:#f92672">.</span>update_instance_metrics(
</span></span><span style="display:flex;"><span>            instance_id<span style="color:#f92672">=</span>instance_id,
</span></span><span style="display:flex;"><span>            active_connections<span style="color:#f92672">=</span>active_connections,
</span></span><span style="display:flex;"><span>            cpu_usage<span style="color:#f92672">=</span>cpu_usage,
</span></span><span style="display:flex;"><span>            memory_usage<span style="color:#f92672">=</span>memory_usage
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        logger<span style="color:#f92672">.</span>error(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Failed to report instance metrics: </span><span style="color:#e6db74">{</span>e<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Background task to report metrics</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_metrics_reporting</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Start background task to report instance metrics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> report_instance_metrics()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> asyncio<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">30</span>)  <span style="color:#75715e"># Report every 30 seconds</span></span></span></code></pre></div><p><strong>Why multi-instance deployment enables true scalability:</strong></p>
<ul>
<li><strong>Horizontal scaling</strong> - Adding more instances linearly increases capacity without exponential cost growth</li>
<li><strong>Fault tolerance</strong> - Multiple instances ensure that single server failures don&rsquo;t take down the entire application</li>
<li><strong>Geographic distribution</strong> - Instances can be deployed in multiple regions to reduce latency for global users</li>
<li><strong>Load distribution</strong> - Intelligent load balancing distributes requests to the least-loaded instances automatically</li>
</ul>
<h3 id="updated-api-layer-with-scaling-features">Updated API Layer with Scaling Features<a class="anchor" href="#updated-api-layer-with-scaling-features">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># main.py - Application startup with scaling optimizations</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> contextlib <span style="color:#f92672">import</span> asynccontextmanager
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> FastAPI, Request
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi.middleware.cors <span style="color:#f92672">import</span> CORSMiddleware
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.background_jobs <span style="color:#f92672">import</span> job_processor
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.core.cache <span style="color:#f92672">import</span> cache
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.deployment.load_balancer <span style="color:#f92672">import</span> instance_registry, start_metrics_reporting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@asynccontextmanager</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lifespan</span>(app: FastAPI):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Application lifespan management for scaling features.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Startup</span>
</span></span><span style="display:flex;"><span>    instance_id <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;INSTANCE_ID&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;instance-</span><span style="color:#e6db74">{</span>os<span style="color:#f92672">.</span>getpid()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;HOST&#34;</span>, <span style="color:#e6db74">&#34;localhost&#34;</span>)
</span></span><span style="display:flex;"><span>    port <span style="color:#f92672">=</span> int(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;PORT&#34;</span>, <span style="color:#e6db74">&#34;8000&#34;</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Register this instance</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> instance_registry<span style="color:#f92672">.</span>register_instance(instance_id, host, port)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start background job workers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>start_workers(num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Start metrics reporting</span>
</span></span><span style="display:flex;"><span>    metrics_task <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>create_task(start_metrics_reporting())
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Application started - Instance: </span><span style="color:#e6db74">{</span>instance_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Shutdown</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> job_processor<span style="color:#f92672">.</span>stop_workers()
</span></span><span style="display:flex;"><span>    metrics_task<span style="color:#f92672">.</span>cancel()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    logger<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Application shutdown - Instance: </span><span style="color:#e6db74">{</span>instance_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> FastAPI(
</span></span><span style="display:flex;"><span>    title<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Neodyme API&#34;</span>,
</span></span><span style="display:flex;"><span>    description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Scalable user management API&#34;</span>,
</span></span><span style="display:flex;"><span>    version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    lifespan<span style="color:#f92672">=</span>lifespan
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CORS middleware for web clients</span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>add_middleware(
</span></span><span style="display:flex;"><span>    CORSMiddleware,
</span></span><span style="display:flex;"><span>    allow_origins<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;*&#34;</span>],  <span style="color:#75715e"># Configure appropriately for production</span>
</span></span><span style="display:flex;"><span>    allow_credentials<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    allow_methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;*&#34;</span>],
</span></span><span style="display:flex;"><span>    allow_headers<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;*&#34;</span>],
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Request tracking middleware</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.middleware.request_tracking <span style="color:#f92672">import</span> RequestTrackingMiddleware
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>add_middleware(RequestTrackingMiddleware)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Include routers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> neodyme.routes <span style="color:#f92672">import</span> users, health, jobs
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>include_router(users<span style="color:#f92672">.</span>router, prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/v1&#34;</span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>include_router(health<span style="color:#f92672">.</span>router, prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/health&#34;</span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>include_router(jobs<span style="color:#f92672">.</span>router, prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/api/v1/jobs&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scaling-specific endpoints</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#34;/cluster/stats&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cluster_stats</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Get cluster-wide statistics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> instance_registry<span style="color:#f92672">.</span>get_cluster_stats()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.get</span>(<span style="color:#e6db74">&#34;/cache/stats&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_cache_stats</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Get cache performance statistics.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> neodyme.core.metrics <span style="color:#f92672">import</span> metrics
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cache_metrics <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key, values <span style="color:#f92672">in</span> metrics<span style="color:#f92672">.</span>histograms<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;cache&#34;</span> <span style="color:#f92672">in</span> key:
</span></span><span style="display:flex;"><span>            cache_metrics[key] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;count&#34;</span>: len(values),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;avg&#34;</span>: sum(values) <span style="color:#f92672">/</span> len(values) <span style="color:#66d9ef">if</span> values <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;recent_values&#34;</span>: values[<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>:]  <span style="color:#75715e"># Last 10 values</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;cache_metrics&#34;</span>: cache_metrics,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;memory_cache_size&#34;</span>: len(cache<span style="color:#f92672">.</span>memory_cache),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;memory_cache_max&#34;</span>: cache<span style="color:#f92672">.</span>max_memory_items
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> uvicorn
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Production-optimized server configuration</span>
</span></span><span style="display:flex;"><span>    uvicorn<span style="color:#f92672">.</span>run(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;main:app&#34;</span>,
</span></span><span style="display:flex;"><span>        host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>        port<span style="color:#f92672">=</span>int(os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;PORT&#34;</span>, <span style="color:#e6db74">&#34;8000&#34;</span>)),
</span></span><span style="display:flex;"><span>        workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,  <span style="color:#75715e"># Use 1 worker per instance, scale with multiple instances</span>
</span></span><span style="display:flex;"><span>        loop<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;uvloop&#34;</span>,  <span style="color:#75715e"># High-performance event loop</span>
</span></span><span style="display:flex;"><span>        http<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;httptools&#34;</span>,  <span style="color:#75715e"># High-performance HTTP parser</span>
</span></span><span style="display:flex;"><span>        access_log<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,  <span style="color:#75715e"># Disable access logs (use middleware instead)</span>
</span></span><span style="display:flex;"><span>        log_config<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,  <span style="color:#75715e"># Use our custom logging configuration</span>
</span></span><span style="display:flex;"><span>    )</span></span></code></pre></div><p><strong>Why application-level scaling coordination is important:</strong></p>
<ul>
<li><strong>Instance awareness</strong> - Applications can coordinate work and avoid duplicating effort across instances</li>
<li><strong>Health monitoring</strong> - Instance health is monitored at the application level, not just the infrastructure level</li>
<li><strong>Graceful scaling</strong> - New instances can register themselves and begin handling traffic automatically</li>
<li><strong>Performance visibility</strong> - Cluster-wide performance metrics enable informed scaling decisions</li>
</ul>
<h2 id="what-youve-learned">What You&rsquo;ve Learned<a class="anchor" href="#what-youve-learned">#</a></h2>
<p>By the end of this chapter, you understand:</p>
<p>✅ <strong>Why vertical scaling fails under real load</strong> - and how single-server approaches create cost and reliability problems that can&rsquo;t be solved with bigger hardware<br>
✅ <strong>How multi-layer caching eliminates database bottlenecks</strong> - using memory and Redis caches to serve frequent requests instantly while maintaining data consistency<br>
✅ <strong>Why background job processing improves user experience</strong> - enabling immediate responses while long-running operations complete asynchronously with proper retry handling<br>
✅ <strong>How database connection optimization prevents resource exhaustion</strong> - using connection pooling and monitoring to handle high concurrency without hitting connection limits<br>
✅ <strong>Why horizontal scaling provides sustainable growth</strong> - distributing load across multiple instances for linear capacity growth and fault tolerance<br>
✅ <strong>How performance monitoring enables data-driven scaling</strong> - using metrics and health checks to understand when and how to scale different components</p>
<p>More importantly, you&rsquo;ve built a scalable architecture that can grow with your success while maintaining the reliability, observability, and clean architecture you&rsquo;ve established throughout the book.</p>
<h2 id="building-blocks-complete-system-architecture">Building Blocks: Complete System Architecture<a class="anchor" href="#building-blocks-complete-system-architecture">#</a></h2>
<p>Your neodyme application now includes:</p>
<ul>
<li><strong>HTTP handling</strong> ← Chapter 1: FastAPI basics</li>
<li><strong>Data persistence</strong> ← Chapter 2: Database integration</li>
<li><strong>Input validation</strong> ← Chapter 3: Request/response validation</li>
<li><strong>Schema evolution</strong> ← Chapter 4: Database migrations</li>
<li><strong>Clean architecture</strong> ← Chapter 5: Service layer organization</li>
<li><strong>Error handling</strong> ← Chapter 6: Professional error management</li>
<li><strong>Security</strong> ← Chapter 7: Authentication and authorization</li>
<li><strong>Configuration</strong> ← Chapter 8: Environment management</li>
<li><strong>Testing</strong> ← Chapter 9: Comprehensive test strategies</li>
<li><strong>Deployment</strong> ← Chapter 10: Production deployment</li>
<li><strong>Observability</strong> ← Chapter 11: Monitoring and debugging</li>
<li><strong>Scaling</strong> ← You are here</li>
</ul>
<p>You&rsquo;ve built a production-ready system that can handle real-world load while remaining maintainable, observable, and reliable.</p>
<h2 id="exercises">Exercises<a class="anchor" href="#exercises">#</a></h2>
<ol>
<li><strong>Implement cache warming</strong> - Pre-populate caches with frequently accessed data during application startup</li>
<li><strong>Add rate limiting</strong> - Prevent individual users from overwhelming your scaled system</li>
<li><strong>Create auto-scaling triggers</strong> - Automatically spawn new instances based on CPU or request volume metrics</li>
<li><strong>Implement circuit breakers</strong> - Prevent cascading failures when external services are overloaded</li>
<li><strong>Build database read replicas</strong> - Scale database reads across multiple database instances</li>
</ol>
<h2 id="resources-for-deeper-learning">Resources for Deeper Learning<a class="anchor" href="#resources-for-deeper-learning">#</a></h2>
<h3 id="scaling-patterns-and-architecture">Scaling Patterns and Architecture<a class="anchor" href="#scaling-patterns-and-architecture">#</a></h3>
<ul>
<li><strong>Designing Data-Intensive Applications</strong>: Comprehensive guide to scalable system design - <a href="https://dataintensive.net/">https://dataintensive.net/</a></li>
<li><strong>High Scalability</strong>: Real-world scaling case studies - <a href="http://highscalability.com/">http://highscalability.com/</a></li>
<li><strong>Microservices Patterns</strong>: Patterns for building scalable distributed systems - <a href="https://microservices.io/patterns/">https://microservices.io/patterns/</a></li>
</ul>
<h3 id="caching-strategies">Caching Strategies<a class="anchor" href="#caching-strategies">#</a></h3>
<ul>
<li><strong>Redis Documentation</strong>: High-performance caching and data structures - <a href="https://redis.io/documentation">https://redis.io/documentation</a></li>
<li><strong>Caching Best Practices</strong>: When and how to cache effectively - <a href="https://aws.amazon.com/caching/best-practices/">https://aws.amazon.com/caching/best-practices/</a></li>
<li><strong>Cache-Aside Pattern</strong>: Implementation patterns for cache consistency - <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cache-aside">https://docs.microsoft.com/en-us/azure/architecture/patterns/cache-aside</a></li>
</ul>
<h3 id="background-processing">Background Processing<a class="anchor" href="#background-processing">#</a></h3>
<ul>
<li><strong>Celery Documentation</strong>: Distributed task queue for Python - <a href="https://docs.celeryproject.org/">https://docs.celeryproject.org/</a></li>
<li><strong>Background Jobs Best Practices</strong>: Patterns for reliable async processing - <a href="https://github.com/psobot/background-jobs-best-practices">https://github.com/psobot/background-jobs-best-practices</a></li>
<li><strong>Queue-Based Load Leveling</strong>: Using queues to handle traffic spikes - <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling">https://docs.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling</a></li>
</ul>
<h3 id="database-performance">Database Performance<a class="anchor" href="#database-performance">#</a></h3>
<ul>
<li><strong>PostgreSQL Performance Tuning</strong>: Optimizing database performance - <a href="https://wiki.postgresql.org/wiki/Performance_Optimization">https://wiki.postgresql.org/wiki/Performance_Optimization</a></li>
<li><strong>Connection Pooling</strong>: Managing database connections at scale - <a href="https://www.postgresql.org/docs/current/runtime-config-connection.html">https://www.postgresql.org/docs/current/runtime-config-connection.html</a></li>
<li><strong>Database Scaling Patterns</strong>: Read replicas, sharding, and partitioning - <a href="https://aws.amazon.com/builders-library/amazon-dynamodb-adaptive-capacity/">https://aws.amazon.com/builders-library/amazon-dynamodb-adaptive-capacity/</a></li>
</ul>
<h3 id="load-balancing-and-deployment">Load Balancing and Deployment<a class="anchor" href="#load-balancing-and-deployment">#</a></h3>
<ul>
<li><strong>Load Balancing Algorithms</strong>: Different strategies for distributing traffic - <a href="https://www.nginx.com/resources/glossary/load-balancing/">https://www.nginx.com/resources/glossary/load-balancing/</a></li>
<li><strong>Blue-Green Deployment</strong>: Zero-downtime deployment patterns - <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">https://martinfowler.com/bliki/BlueGreenDeployment.html</a></li>
<li><strong>Container Orchestration</strong>: Kubernetes patterns for scaling applications - <a href="https://kubernetes.io/docs/concepts/">https://kubernetes.io/docs/concepts/</a></li>
</ul>
<h3 id="why-these-resources-matter">Why These Resources Matter<a class="anchor" href="#why-these-resources-matter">#</a></h3>
<ul>
<li><strong>System design principles</strong>: Understanding scalability patterns helps you design systems that grow efficiently</li>
<li><strong>Performance optimization</strong>: Learning caching and database optimization prevents common scaling bottlenecks</li>
<li><strong>Distributed systems</strong>: Understanding distributed system challenges helps you build reliable scaled applications</li>
<li><strong>Real-world examples</strong>: Case studies from high-traffic sites provide proven patterns and anti-patterns</li>
</ul>
<p><strong>Pro Tip</strong>: Start with caching and background jobs for immediate performance improvements, then focus on horizontal scaling as traffic grows beyond single-server capacity.</p>
<h2 id="conclusion-from-tutorial-to-production">Conclusion: From Tutorial to Production<a class="anchor" href="#conclusion-from-tutorial-to-production">#</a></h2>
<p>Congratulations! You&rsquo;ve built neodyme from a simple FastAPI tutorial into a production-ready, scalable application. More importantly, you understand WHY each architectural decision matters and how all the pieces work together.</p>
<p>Your neodyme application now has:</p>
<p>✅ <strong>Professional API design</strong> with comprehensive input validation and clear error messages<br>
✅ <strong>Clean architecture</strong> that separates concerns and makes testing straightforward<br>
✅ <strong>Robust error handling</strong> that helps users and developers debug issues quickly<br>
✅ <strong>Comprehensive observability</strong> that makes production debugging fast and reliable<br>
✅ <strong>Scalable infrastructure</strong> that can grow with your success without breaking</p>
<p>But most importantly, you understand the <strong>engineering principles</strong> behind these patterns:</p>
<ul>
<li><strong>Why separation of concerns makes code maintainable</strong></li>
<li><strong>How proper error handling enables reliable operations</strong></li>
<li><strong>Why observability is essential for production systems</strong></li>
<li><strong>How caching and async processing enable performance at scale</strong></li>
</ul>
<p>These principles will serve you throughout your career as you build increasingly complex systems. The specific technologies will change, but the fundamental patterns of clean architecture, comprehensive error handling, and scalable design remain constant.</p>
<p><strong>Welcome to production-ready Python development.</strong> You&rsquo;re now equipped to build systems that not only work, but work reliably under real-world conditions.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/neodyme/docs/chapter-11/" class="flex align-center">
        <img src="/neodyme/icons/backward.svg" class="book-icon" alt="Previous" title="Chapter 11" />
        <span>Chapter 11</span>
      </a>
    
    </span>
    <span>
    
    </span>
  </div>
  




  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
  
  <div class="book-comments">

</div>
  
 
        
        

 
      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    

<aside class="book-toc">
  <div class="book-toc-content">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem-success-that-kills-performance">The Problem: Success That Kills Performance</a></li>
    <li><a href="#why-just-buy-a-bigger-server-doesnt-work">Why &ldquo;Just Buy a Bigger Server&rdquo; Doesn&rsquo;t Work</a></li>
    <li><a href="#the-horizontal-scaling-solution-distributed-architecture">The Horizontal Scaling Solution: Distributed Architecture</a>
      <ul>
        <li><a href="#caching-eliminating-redundant-work">Caching: Eliminating Redundant Work</a></li>
        <li><a href="#cached-service-layer-implementation">Cached Service Layer Implementation</a></li>
        <li><a href="#background-job-processing-async-operations">Background Job Processing: Async Operations</a></li>
        <li><a href="#updated-service-layer-with-background-jobs">Updated Service Layer with Background Jobs</a></li>
        <li><a href="#database-connection-optimization">Database Connection Optimization</a></li>
        <li><a href="#load-balancing-and-multi-instance-deployment">Load Balancing and Multi-Instance Deployment</a></li>
        <li><a href="#updated-api-layer-with-scaling-features">Updated API Layer with Scaling Features</a></li>
      </ul>
    </li>
    <li><a href="#what-youve-learned">What You&rsquo;ve Learned</a></li>
    <li><a href="#building-blocks-complete-system-architecture">Building Blocks: Complete System Architecture</a></li>
    <li><a href="#exercises">Exercises</a></li>
    <li><a href="#resources-for-deeper-learning">Resources for Deeper Learning</a>
      <ul>
        <li><a href="#scaling-patterns-and-architecture">Scaling Patterns and Architecture</a></li>
        <li><a href="#caching-strategies">Caching Strategies</a></li>
        <li><a href="#background-processing">Background Processing</a></li>
        <li><a href="#database-performance">Database Performance</a></li>
        <li><a href="#load-balancing-and-deployment">Load Balancing and Deployment</a></li>
        <li><a href="#why-these-resources-matter">Why These Resources Matter</a></li>
      </ul>
    </li>
    <li><a href="#conclusion-from-tutorial-to-production">Conclusion: From Tutorial to Production</a></li>
  </ul>
</nav>



  </div>
</aside>

 
  </main>

  
</body>
</html>


















